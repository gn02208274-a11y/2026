<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 å±±æ¢¨ç”²æ–æ—… (é™¤éŒ¯å¢å¼·ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;800&display=swap" rel="stylesheet">
    
    <!-- ç¶²ç«™åœ–ç¤º (Favicon) -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EğŸƒ%3C/text%3E%3C/svg%3E">

    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --ac-green: #78B159; --ac-cream: #FDFBF0; --ac-brown: #7C5E45; --ac-blue: #64C3D9; --ac-yellow: #F7E464; --ac-text: #594A3D; --ac-orange: #FFB74D; }
        body { font-family: 'M PLUS Rounded 1c', sans-serif; background-color: var(--ac-cream); color: var(--ac-text); background-image: radial-gradient(#E6F2D6 15%, transparent 16%), radial-gradient(#E6F2D6 15%, transparent 16%); background-size: 30px 30px; background-position: 0 0, 15px 15px; }
        
        .nook-card { background-color: white; border-radius: 1rem; box-shadow: 4px 4px 0 rgba(124, 94, 69, 0.1); border: 2px solid #E0E0E0; transition: transform 0.2s; }
        .nook-card:hover { transform: translateY(-2px); box-shadow: 6px 6px 0 rgba(124, 94, 69, 0.15); }
        .nook-btn { border-radius: 9999px; font-weight: 800; transition: all 0.2s; cursor: pointer; }
        .nook-btn:active { transform: scale(0.95); }
        .leaf-icon { display: inline-block; width: 1.2em; height: 1.2em; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2378B159'%3E%3Cpath d='M12 2C9 2 4 5 4 10C4 13 6 15 8 16L9 22H11L10 16.5C10 16.5 13 17 15 15C18 12 20 8 20 5C20 3 18 2 12 2ZM12 4C16 4 17 7 15 10C13 13 10 14 10 14C10 14 11.5 10 9 7C7 5 5 6 5 6C5 6 7 4 12 4Z'/%3E%3C/svg%3E"); background-size: contain; background-repeat: no-repeat; vertical-align: middle; }
        .nav-link { cursor: pointer; padding: 0.5rem 1rem; border-radius: 9999px; font-weight: bold; color: white; opacity: 0.8; transition: all 0.2s; }
        .nav-link:hover, .nav-link.active { background-color: rgba(255,255,255,0.2); opacity: 1; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: flex; justify-content: center; align-items: center; padding: 1rem; backdrop-filter: blur(4px); }
        .modal-content { background: #FDFBF0; border-radius: 1.5rem; padding: 2rem; width: 100%; max-width: 400px; border: 4px solid #F7E464; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 30px; font-size: 14px; opacity: 0; transition: opacity 0.5s, bottom 0.5s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        
        /* è©³ç´°è¡Œç¨‹æ¨£å¼ */
        .timeline-line { position: absolute; left: 1.25rem; top: 0; bottom: 0; border-left: 4px dashed var(--ac-brown); z-index: 0; }
        .transport-card { background-color: #E0F7FA; border: 2px dashed var(--ac-blue); border-radius: 1rem; padding: 0.75rem; margin-top: 0.75rem; font-size: 0.85rem; color: #006064; position: relative; }
        .transport-card::before { content: "âœˆï¸ DAL"; position: absolute; top: -10px; right: 10px; background: var(--ac-blue); color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        
        /* å·´å£«åœ–æ¨£å¼ */
        .bus-route-container { position: relative; padding: 20px 0; } .bus-line-red { border-top: 4px solid #E53935; position: relative; margin: 20px 0; } .bus-line-green { border-top: 4px solid #43A047; position: relative; margin: 20px 0; }
        .bus-stop { position: absolute; top: -12px; width: 20px; height: 20px; background: white; border-radius: 50%; border: 3px solid #ccc; transform: translateX(-50%); } .bus-stop.active { border-color: #004D40; background: #B2DFDB; width: 24px; height: 24px; top: -14px; z-index: 10; }
        .bus-label { position: absolute; top: 20px; transform: translateX(-50%); font-size: 0.75rem; text-align: center; width: 80px; line-height: 1.2; font-weight: bold; color: var(--ac-text); } .bus-label-top { position: absolute; top: -45px; transform: translateX(-50%); font-size: 0.85rem; text-align: center; width: 120px; font-weight: 800; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div id="toast">å·²è¤‡è£½é€£çµï¼</div>

    <!-- ç™»å…¥èˆ‡è¨­å®šé®ç½© -->
    <div id="login-modal" class="modal">
        <div class="modal-content text-center">
            <div class="w-20 h-20 bg-white rounded-full mx-auto mb-4 flex items-center justify-center border-4 border-[#78B159] shadow-sm">
                <span class="leaf-icon w-12 h-12"></span>
            </div>
            <h2 class="text-2xl font-black text-[#7C5E45] mb-2">é–‹å§‹æ—…ç¨‹</h2>
            <p class="text-sm text-gray-500 mb-6 font-bold">è«‹è¼¸å…¥ã€Œæ—…è²»ä»£ç¢¼ã€èˆ‡æ—…ä¼´åŒæ­¥è³‡æ–™</p>
            
            <div class="space-y-4">
                <input type="text" id="travel-id-input" placeholder="è¨­å®šä¸€å€‹ä»£ç¢¼ (ä¾‹: Trip2026)" class="w-full bg-white border-2 border-gray-300 rounded-xl p-3 text-center font-bold text-lg text-[#7C5E45] outline-none focus:border-[#78B159]">
                <button onclick="saveTravelId()" class="w-full bg-[#78B159] text-white font-black py-3 rounded-xl shadow-md nook-btn text-lg hover:bg-[#689F4D]">ğŸš€ é€²å…¥ç¶²ç«™</button>
            </div>

            <div class="mt-8 pt-4 border-t border-gray-200">
                <button onclick="toggleConfigPanel()" class="text-xs text-gray-400 font-bold underline hover:text-gray-600">ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Ÿè«‹å…ˆé»æ­¤è¨­å®šé›²ç«¯è³‡æ–™åº«</button>
            </div>
            
            <!-- Config è¨­å®šå€ -->
            <div id="config-panel" class="hidden mt-4 text-left bg-gray-50 p-3 rounded-lg border border-gray-200">
                <p class="text-xs text-gray-500 mb-2 font-bold">è«‹è²¼ä¸Š Firebase Config:</p>
                <textarea id="config-input" class="w-full h-32 text-[11px] bg-white p-2 rounded border border-gray-300 font-mono mb-2 shadow-inner" placeholder='const firebaseConfig = { ... }'></textarea>
                <button onclick="saveConfig()" class="w-full bg-[#F7E464] text-[#7C5E45] font-bold py-2 rounded-lg text-sm hover:bg-[#FFD54F]">å„²å­˜ä¸¦è‡ªå‹•ä¿®å¾©æ ¼å¼</button>
            </div>
        </div>
    </div>

    <!-- é ‚éƒ¨å°è¦½åˆ— -->
    <nav class="bg-[#78B159] shadow-md sticky top-0 z-50 hidden" id="main-nav">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-2 cursor-pointer" onclick="switchView('dashboard')">
                    <div class="w-10 h-10 bg-[#FDFBF0] rounded-full flex items-center justify-center border-2 border-[#F7E464] transform -rotate-12">
                        <span class="leaf-icon"></span>
                    </div>
                    <span class="font-extrabold text-xl text-[#FDFBF0] tracking-wider hidden sm:block">Nook Travel</span>
                    <!-- é€£ç·šç‹€æ…‹ç‡ˆ -->
                    <div id="connection-status" class="w-3 h-3 rounded-full bg-red-400 border border-white" title="æœªé€£ç·š"></div>
                </div>
                
                <div class="hidden md:flex space-x-1">
                    <a onclick="switchView('dashboard')" class="nav-link active" id="nav-dashboard">ç¸½è¦½</a>
                    <a onclick="switchView('itinerary')" class="nav-link" id="nav-itinerary">è¡Œç¨‹</a>
                    <a onclick="switchView('transport')" class="nav-link" id="nav-transport">äº¤é€š</a>
                    <a onclick="switchView('accounting')" class="nav-link" id="nav-accounting">è¨˜å¸³</a>
                    <a onclick="switchView('lists')" class="nav-link" id="nav-lists">æ¸…å–®</a>
                    <a onclick="switchView('hotels')" class="nav-link" id="nav-hotels">ä½å®¿</a>
                    <a onclick="switchView('tips')" class="nav-link" id="nav-tips">è²¼å£«</a>
                </div>

                <div class="md:hidden">
                    <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="text-white font-bold p-2">
                        <span class="text-2xl">â˜°</span>
                    </button>
                </div>

                <div class="flex items-center ml-4">
                     <span class="text-xs bg-black/20 text-white px-3 py-1 rounded-full font-bold cursor-pointer hover:bg-black/30 transition" onclick="logout()" id="id-badge">ID: --</span>
                </div>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-[#689F4D] p-2">
            <a onclick="switchView('dashboard'); closeMenu()" class="block px-4 py-2 text-white font-bold hover:bg-black/10 rounded">ğŸ“Š ç¸½è¦½</a>
            <a onclick="switchView('itinerary'); closeMenu()" class="block px-4 py-2 text-white font-bold hover:bg-black/10 rounded">ğŸ“… è¡Œç¨‹</a>
            <a onclick="switchView('transport'); closeMenu()" class="block px-4 py-2 text-white font-bold hover:bg-black/10 rounded">ğŸšŒ äº¤é€š</a>
            <a onclick="switchView('accounting'); closeMenu()" class="block px-4 py-2 text-white font-bold hover:bg-black/10 rounded">ğŸ’° è¨˜å¸³</a>
            <a onclick="switchView('lists'); closeMenu()" class="block px-4 py-2 text-white font-bold hover:bg-black/10 rounded">ğŸ“ æ¸…å–®</a>
            <a onclick="switchView('hotels'); closeMenu()" class="block px-4 py-2 text-white font-bold hover:bg-black/10 rounded">ğŸ¡ ä½å®¿</a>
            <a onclick="switchView('tips'); closeMenu()" class="block px-4 py-2 text-white font-bold hover:bg-black/10 rounded">ğŸ’¡ è²¼å£«</a>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main id="main-content" class="container mx-auto px-4 py-6 max-w-4xl flex-grow hidden">
        
        <!-- ç¸½è¦½é é¢ -->
        <section id="view-dashboard" class="space-y-6 fade-in">
            <div class="text-center mb-6">
                <h1 class="text-2xl md:text-3xl font-black text-[#7C5E45] mb-2">2026 å±±æ¢¨ç”²æ–ãƒ»éœè¬ä¹‹æ—…</h1>
                <div class="flex justify-center gap-2 mb-2">
                    <p class="text-sm text-gray-500 font-bold bg-white inline-block px-3 py-1 rounded-full border border-gray-200">å…©äººåŒè¡Œ â€¢ No Beef â€¢ é›²ç«¯åŒæ­¥</p>
                </div>
                <button onclick="copyShareLink()" class="text-xs bg-[#78B159] text-white px-3 py-1.5 rounded-full font-bold shadow-sm hover:bg-[#689F4D] transition flex items-center justify-center mx-auto">ğŸ”— è¤‡è£½é‚€è«‹é€£çµ</button>
            </div>

            <div class="nook-card p-6 border-t-8 border-[#F7E464]">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                    <h2 class="text-xl font-black text-[#7C5E45] flex items-center mb-2 md:mb-0"><span class="text-2xl mr-2">ğŸ’°</span> é ç®—ç›£æ§</h2>
                    <div class="text-right">
                        <span class="text-sm text-gray-500 font-bold">ç¸½èŠ±è²» (TWD)</span>
                        <div class="text-3xl font-black text-[#E65100]" id="total-spent">--</div>
                    </div>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-4 mb-4 overflow-hidden shadow-inner">
                    <div class="bg-[#78B159] h-4 inline-block" style="width: 40%" title="å›ºå®šæ”¯å‡º"></div><div class="bg-[#FFB74D] h-4 inline-block transition-all duration-500" id="variable-bar" style="width: 0%" title="æµ®å‹•æ”¯å‡º"></div>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm font-bold text-gray-600 bg-gray-50 p-4 rounded-xl">
                    <div>âœˆï¸ å›ºå®šæ”¯å‡º (æ©Ÿ+é…’): <span class="text-[#78B159]">36,046</span></div>
                    <div>ğŸ± æµ®å‹•æ”¯å‡º (åƒå–ç©æ¨‚): <span class="text-[#E65100]" id="variable-spent">0</span></div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div onclick="switchView('itinerary')" class="nook-card p-4 flex flex-col items-center justify-center cursor-pointer hover:bg-[#FFF9C4]">
                    <span class="text-3xl mb-1">ğŸ“…</span> <span class="font-bold text-[#7C5E45]">çœ‹è¡Œç¨‹</span>
                </div>
                <div onclick="switchView('accounting')" class="nook-card p-4 flex flex-col items-center justify-center cursor-pointer hover:bg-[#E0F7FA]">
                    <span class="text-3xl mb-1">ğŸ“</span> <span class="font-bold text-[#006064]">è¨˜ä¸€ç­†</span>
                </div>
                <div onclick="switchView('lists')" class="nook-card p-4 flex flex-col items-center justify-center cursor-pointer hover:bg-[#FFEBEE]">
                    <span class="text-3xl mb-1">ğŸ’</span> <span class="font-bold text-[#E53935]">ç‰©å“æ¸…å–®</span>
                </div>
                <div onclick="switchView('transport')" class="nook-card p-4 flex flex-col items-center justify-center cursor-pointer hover:bg-[#E8F5E9]">
                    <span class="text-3xl mb-1">ğŸšŒ</span> <span class="font-bold text-[#558B2F]">äº¤é€šæ”»ç•¥</span>
                </div>
            </div>
        </section>

        <!-- è¡Œç¨‹é é¢ -->
        <section id="view-itinerary" class="hidden space-y-6 fade-in">
            <h2 class="text-2xl font-black text-[#7C5E45] border-l-4 border-[#F7E464] pl-3">æ¯æ—¥è¡Œç¨‹</h2>
            <div class="flex overflow-x-auto space-x-2 pb-2">
                <button onclick="renderDay(1)" class="flex-1 py-2 px-4 rounded-full font-bold whitespace-nowrap bg-[#FDFBF0] border border-gray-200 text-gray-500 day-tab" id="tab-day1">3/13 (äº”)</button>
                <button onclick="renderDay(2)" class="flex-1 py-2 px-4 rounded-full font-bold whitespace-nowrap bg-[#FDFBF0] border border-gray-200 text-gray-500 day-tab" id="tab-day2">3/14 (å…­)</button>
                <button onclick="renderDay(3)" class="flex-1 py-2 px-4 rounded-full font-bold whitespace-nowrap bg-[#FDFBF0] border border-gray-200 text-gray-500 day-tab" id="tab-day3">3/15 (æ—¥)</button>
                <button onclick="renderDay(4)" class="flex-1 py-2 px-4 rounded-full font-bold whitespace-nowrap bg-[#FDFBF0] border border-gray-200 text-gray-500 day-tab" id="tab-day4">3/16 (ä¸€)</button>
                <button onclick="renderDay(5)" class="flex-1 py-2 px-4 rounded-full font-bold whitespace-nowrap bg-[#FDFBF0] border border-gray-200 text-gray-500 day-tab" id="tab-day5">3/17 (äºŒ)</button>
            </div>
            <div id="day-content"></div>
        </section>

        <!-- äº¤é€šé é¢ -->
        <section id="view-transport" class="hidden space-y-6 fade-in">
            <h2 class="text-2xl font-black text-[#7C5E45] border-l-4 border-[#64C3D9] pl-3">äº¤é€šæ”»ç•¥</h2>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <button onclick="renderTransportDetail('day3')" class="flex-1 bg-[#E0F7FA] text-[#006064] py-3 rounded-xl font-bold border-2 border-[#64C3D9] hover:bg-[#B2EBF2]">ğŸšŒ Day 3 ç§»å‹•è©³è§£</button>
                <button onclick="renderTransportDetail('local')" class="flex-1 bg-[#E8F5E9] text-[#2E7D32] py-3 rounded-xl font-bold border-2 border-[#43A047] hover:bg-[#C8E6C9]">ğŸ—ºï¸ æ²³å£æ¹–å‘¨éŠå·´å£«</button>
                <button onclick="renderTransportDetail('return')" class="flex-1 bg-[#FFF3E0] text-[#E65100] py-3 rounded-xl font-bold border-2 border-[#FFB74D] hover:bg-[#FFE0B2]">ğŸš† å›ç¨‹é›»è»Šæ™‚åˆ»</button>
            </div>
            <div id="transport-detail-container"></div>
        </section>

        <!-- è¨˜å¸³é é¢ -->
        <section id="view-accounting" class="hidden space-y-6 fade-in">
            <h2 class="text-2xl font-black text-[#7C5E45] border-l-4 border-[#78B159] pl-3">æ—…è²»è¨˜å¸³æœ¬</h2>
            <div class="nook-card p-6 bg-[#FDFBF0] border-2 border-[#F7E464]">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 mb-3">
                    <div class="md:col-span-2"><select id="acc-cat" class="w-full p-3 rounded-xl border border-gray-200 font-bold text-[#558B2F] bg-white outline-none"><option>ğŸ± é£Ÿ</option><option>ğŸš† è¡Œ</option><option>ğŸŸï¸ æ¨‚</option><option>ğŸ›ï¸ è²·</option><option>ğŸ¨ ä½</option></select></div>
                    <div class="md:col-span-6"><input type="text" id="acc-item" placeholder="ä¾‹å¦‚: é¤ºé£¥éºµåˆé¤" class="w-full p-3 rounded-xl border border-gray-200 bg-white outline-none"></div>
                    <div class="md:col-span-4 flex"><input type="number" id="acc-amt" placeholder="0" class="w-full p-3 rounded-l-xl border border-gray-200 border-r-0 bg-white outline-none"><select id="acc-curr" class="bg-[#FFF9C4] border border-gray-200 border-l-0 rounded-r-xl px-2 font-bold text-[#E65100] outline-none"><option value="JPY">Â¥ JPY</option><option value="TWD">$ TWD</option></select></div>
                </div>
                <button onclick="addExpense()" class="w-full bg-[#78B159] text-white font-bold py-3 rounded-xl shadow hover:bg-[#689F4D] transition">ï¼‹ æ–°å¢ç´€éŒ„</button>
            </div>
            <div id="expense-list" class="space-y-3"><div class="text-center text-gray-400 py-10">è³‡æ–™è®€å–ä¸­...</div></div>
        </section>

        <!-- æ¸…å–®é é¢ -->
        <section id="view-lists" class="hidden space-y-6 fade-in">
            <h2 class="text-2xl font-black text-[#7C5E45] border-l-4 border-[#64C3D9] pl-3">æª¢æŸ¥æ¸…å–®</h2>
            <div class="flex space-x-2 bg-white p-1 rounded-xl shadow-sm border border-gray-200">
                <button onclick="listMode='pack'; renderLists()" id="btn-pack" class="flex-1 py-2 rounded-lg font-bold transition bg-[#FFF3E0] text-[#E65100]">ğŸ’ å‡ºç™¼å¿…å¸¶</button>
                <button onclick="listMode='shop'; renderLists()" id="btn-shop" class="flex-1 py-2 rounded-lg font-bold transition text-gray-500 hover:bg-gray-50">ğŸ›ï¸ è³¼ç‰©é¡˜æœ›</button>
            </div>
            <div class="flex gap-2"><input type="text" id="list-input" class="flex-grow p-3 rounded-xl border-2 border-gray-200 outline-none focus:border-[#64C3D9]" placeholder="æ–°å¢å¾…è¾¦äº‹é …..."><button onclick="addListItem()" class="bg-[#64C3D9] text-white px-6 rounded-xl font-bold text-xl shadow hover:bg-[#4FA3B8]">+</button></div>
            <div id="list-container" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
        </section>

        <!-- ä½å®¿é é¢ -->
        <section id="view-hotels" class="hidden space-y-6 fade-in">
            <h2 class="text-2xl font-black text-[#7C5E45] border-l-4 border-[#B8860B] pl-3">ä½å®¿æƒ…å ±</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="nook-card p-6 border-l-8 border-[#B8860B] h-full flex flex-col"><h3 class="text-xl font-black text-[#7C5E45]">ğŸ¦‰ å‰åŠæ®µï¼šãƒ•ã‚¯ãƒ­ã‚¦ã®å¾¡å®¿ æ˜¥æ—¥å±…é¤¨</h3><p class="text-sm text-gray-600 mb-2 font-bold">3/13 - 3/15 (2æ™š)</p><ul class="text-sm space-y-2 list-disc list-inside text-[#594A3D] flex-grow"><li>å¤æ°‘å®¶æ”¹å»ºã€ç§äººæº«æ³‰ã€‚</li><li>è¨‚æˆ¿ç¶²è©•åˆ† 8.5ã€‚</li><li>å·²ä»˜æ¸… (NT$ 3,858)ã€‚</li></ul><a href="https://maps.google.com/?q=Fukurou+No+Oyado+Kasugaikan" target="_blank" class="mt-4 text-center block w-full bg-[#FFF9C4] text-[#7C5E45] py-2 rounded-lg font-bold text-xs hover:bg-[#F7E464]">ğŸ—ºï¸ é–‹å•Ÿåœ°åœ–</a></div>
                <div class="nook-card p-6 border-l-8 border-[#E57373] h-full flex flex-col"><h3 class="text-xl font-black text-[#7C5E45]">ğŸª å¾ŒåŠæ®µï¼šHOTORI no HOTEL BAN</h3><p class="text-sm text-gray-600 mb-2 font-bold">3/15 - 3/17 (2æ™š)</p><ul class="text-sm space-y-2 list-disc list-inside text-[#594A3D] flex-grow"><li>æ¨“ä¸‹å…¨å®¶ã€é¢æ¹–ã€æˆ¿é–“å¤§ã€‚</li><li>è¨‚æˆ¿ç¶²è©•åˆ† 8.9ã€‚</li><li>å·²ä»˜æ¸… (NT$ 9,922)ã€‚</li></ul><a href="https://maps.google.com/?q=HOTORI+no+HOTEL+BAN" target="_blank" class="mt-4 text-center block w-full bg-[#FFEBEE] text-[#E53935] py-2 rounded-lg font-bold text-xs hover:bg-[#FFCDD2]">ğŸ—ºï¸ é–‹å•Ÿåœ°åœ–</a></div>
            </div>
        </section>

        <!-- è²¼å£«é é¢ -->
        <section id="view-tips" class="hidden space-y-6 fade-in">
            <h2 class="text-2xl font-black text-[#7C5E45] border-l-4 border-[#FFCC80] pl-3">é£²é£ŸæŒ‡å—</h2>
            <div class="nook-card p-6 border-4 border-[#FFCC80]"><h3 class="text-xl font-black text-[#EF6C00] mb-4">No Beef / No Alcohol</h3><div class="space-y-4"><div class="bg-[#FFF3E0] p-4 rounded-xl"><div class="font-bold text-[#7C5E45]">ğŸ² Hoto Fudo (é¤ºé£¥éºµ)</div><div class="text-sm text-gray-600">å‘³å™Œè”¬èœåº•ï¼Œå®‰å…¨é¦–é¸ã€‚</div></div><div class="bg-[#FFF3E0] p-4 rounded-xl"><div class="font-bold text-[#7C5E45]">ğŸ· ç”²å·å¯Œå£«æ«»è±¬</div><div class="text-sm text-gray-600">ç‚¸è±¬æ’æˆ–æ¶®æ¶®é‹ï¼Œä¸å«ç‰›ã€‚</div></div><div class="bg-[#FFF3E0] p-4 rounded-xl"><div class="font-bold text-[#7C5E45]">ğŸ“ Gourmet è‹ºå‰ç”°</div><div class="text-sm text-gray-600">30åˆ†é˜åƒåˆ°é£½ï¼Œç…‰ä¹³å…è²»ã€‚</div></div></div></div>
        </section>

    </main>

    <footer class="bg-[#78B159] text-white py-6 mt-auto hidden text-center text-sm font-bold" id="main-footer">
        Â© 2026 å±±æ¢¨ç”²æ–æ—… | å…±ç”¨ä»£ç¢¼: <span id="footer-id">--</span>
    </footer>

    <script>
        const FIXED_COST = 36046;
        const RATE = 0.215;
        let db, auth;
        let appId = null; 
        let expenses = [];
        let packList = [];
        let shopList = [];
        let listMode = 'pack';

        const itineraryData = {
            1: { title: "3/13 (äº”) Day 1: æŠµé”èˆ‡æº«æ³‰", highlights: ["è™èˆª IT200", "N'EX", "å¤æ°‘å®¶"], stay: "å¤æ°‘å®¶", timeline: [ { time: "10:35", icon: "ğŸ›¬", title: "æŠµé”æˆç”° (NRT)", desc: "IT200 æŠµé”ã€‚é ˜è¡Œæã€éæµ·é—œã€‚", cost: "ç„¡", mapQuery: "Narita International Airport", transport: { mode: "N'EX", route: "æˆç”° -> æ–°å®¿", duration: "80åˆ†", note: "å»ºè­° 11:44 æˆ– 12:20" } }, { time: "11:44", icon: "ğŸš†", title: "N'EX å‰å¾€æ–°å®¿", desc: "æ­ä¹˜ N'EX æˆç”°ç‰¹å¿«ã€‚", cost: "Â¥3,270", mapQuery: "Shinjuku Station", transport: { mode: "ç‰¹æ€¥", route: "æ–°å®¿è½‰ä¹˜ Kaiji", duration: "è½‰ä¹˜æ™‚é–“ç´„ 20åˆ†", note: "9/10 æœˆå°" } }, { time: "13:30", icon: "ğŸš„", title: "è½‰ä¹˜ Kaiji ç‰¹æ€¥", desc: "æ–°å®¿è½‰ä¹˜ JR Kaiji è™Ÿå¾€çŸ³å’Œæº«æ³‰ã€‚", cost: "Â¥3,890", mapQuery: "Isawa-Onsen Station", transport: { mode: "Kaiji", route: "æ–°å®¿ -> çŸ³å’Œæº«æ³‰", duration: "90åˆ†", note: "ç›´é”" } }, { time: "15:00", icon: "ğŸš•", title: "å‰å¾€æ°‘å®¿", desc: "çŸ³å’Œæº«æ³‰ç«™æ­è¨ˆç¨‹è»Šè‡³å¤æ°‘å®¶ã€‚", cost: "ç´„ Â¥1,500", mapQuery: "ãƒ•ã‚¯ãƒ­ã‚¦ã®å¾¡å®¿ æ˜¥æ—¥å±…é¤¨", transport: { mode: "Taxi", route: "è»Šç«™ -> æ°‘å®¿", duration: "10åˆ†", note: "å—å£æ’ç­è¨ˆç¨‹è»Š" } }, { time: "18:00", icon: "ğŸ±", title: "æ™šé¤", desc: "äº«ç”¨åœ¨è»Šç«™è²·çš„ä¾¿ç•¶æˆ–é™„è¿‘çš„é¤å»³ã€‚", cost: "ç´„ Â¥1,500/äºº" } ] },
            2: { title: "3/14 (å…­) Day 2: è‰è“èˆ‡æºªè°·", highlights: ["Gourmet è‹º", "æ˜‡ä»™å³½", "ç‚¸è±¬æ’"], stay: "å¤æ°‘å®¶", timeline: [ { time: "09:00", icon: "ğŸ¯", title: "æƒ æ—å¯ºåƒæ‹œ", desc: "æ­¦ç”°ä¿¡ç„é•·çœ ä¹‹åœ°ï¼Œåº­åœ’æ¥µç¾ã€‚", hours: "8:30 - 16:30", cost: "é–€ç¥¨ Â¥300", mapQuery: "Erinji Temple", transport: { mode: "Taxi", route: "æ°‘å®¿ -> æƒ æ—å¯º", duration: "20åˆ†", note: "è«‹æ°‘å®¿å¹«å¿™å«è»Š" } }, { time: "11:00", icon: "ğŸ“", title: "Gourmet è‹ºå‰ç”°", desc: "é«˜ç´šè‰è“åƒåˆ°é£½ (30åˆ†)ã€‚", hours: "10:00 - 16:00 (éœ€é ç´„)", cost: "Â¥2,500/äºº", mapQuery: "Gourmet Strawberry Museum Maeda", transport: { mode: "Taxi", route: "æƒ æ—å¯º -> è‰è“åœ’", duration: "30åˆ†", note: "è»Šè³‡ç´„ Â¥4000 (è¼ƒè²´ä½†çœæ™‚)" } }, { time: "13:30", icon: "ğŸï¸", title: "æ˜‡ä»™å³½", desc: "æ­å·´å£«å‰å¾€ï¼Œæ¬£è³çµ•ç¾æºªè°·ã€‚", hours: "å…¨å¤©é–‹æ”¾", cost: "ä¾†å› Â¥1,200", mapQuery: "Shosenkyo", transport: { mode: "å·´å£«", route: "ç”²åºœç«™(å—å£4è™Ÿ) -> æ˜‡ä»™å³½å£", duration: "30åˆ†", note: "å±±æ¢¨äº¤é€šå·´å£«" } }, { time: "18:30", icon: "ğŸ·", title: "ç”²åºœæ™šé¤", desc: "ç”²å·å¯Œå£«æ«»è±¬ç‚¸è±¬æ’ã€‚", hours: "17:00 - 21:00", cost: "ç´„ Â¥2,000/äºº", mapQuery: "Kofu Station", transport: { mode: "JR", route: "ç”²åºœ -> çŸ³å’Œæº«æ³‰", duration: "10åˆ†", note: "å›ç¨‹" } } ] },
            3: { title: "3/15 (æ—¥) Day 3: ç§»å‹•è‡³æ²³å£æ¹–", highlights: ["è·¨å€å·´å£«", "è¥¿æ¹–æ ¹å ´", "å¤§çŸ³å…¬åœ’"], stay: "HOTORI", timeline: [ { time: "10:08", icon: "ğŸšŒ", title: "ç›´é”å·´å£«", desc: "çŸ³å’Œæº«æ³‰ç™¼è»Šï¼Œå‰å¾€æ²³å£æ¹–ç«™ã€‚", cost: "Â¥1,400/äºº", mapQuery: "Isawa-Onsen Station", transport: { mode: "å¯Œå£«æ€¥å·´å£«", route: "çŸ³å’Œæº«æ³‰ -> æ²³å£æ¹–ç«™", duration: "50åˆ†", note: "å¿…æ­ 10:08 ç­æ¬¡!" } }, { time: "12:00", icon: "ğŸ˜ï¸", title: "è¥¿æ¹–ç™‚ç™’ä¹‹é‡Œæ ¹å ´", desc: "åƒè§€èŒ…è‰å±‹èšè½ã€åƒåˆé¤ã€‚", hours: "9:00 - 17:00", cost: "é–€ç¥¨ Â¥500", mapQuery: "Saiko Iyashi-no-Sato Nenba", transport: { mode: "ç¶ ç·šå·´å£«", route: "æ²³å£æ¹–ç«™ -> è¥¿æ¹–æ ¹å ´", duration: "40åˆ†", note: "1è™Ÿä¹˜è»Šè™•" } }, { time: "15:00", icon: "ğŸŒ¸", title: "å¤§çŸ³å…¬åœ’", desc: "ç´…ç·šå·´å£«çµ‚é»ï¼Œå…è²»å…¥åœ’ã€‚", hours: "å…¨å¤©é–‹æ”¾ (å•†åº—~17:00)", cost: "å…è²»", mapQuery: "Oishi Park", transport: { mode: "è½‰ä¹˜", route: "ç¶ ç·šå›è»Šç«™ -> ç´…ç·šå»å¤§çŸ³", duration: "60åˆ†", note: "éœ€å›æ²³å£æ¹–ç«™è½‰è»Š" } }, { time: "16:30", icon: "ğŸ¨", title: "Check-in", desc: "å…¥ä½ HOTORI Hotelã€‚", cost: "å·²ä»˜", mapQuery: "HOTORI no HOTEL BAN", transport: { mode: "ç´…ç·šå·´å£«", route: "å¤§çŸ³å…¬åœ’ -> éŸ³æ¨‚ç›’ä¹‹æ£®", duration: "10åˆ†", note: "é£¯åº—åœ¨ç«™ç‰Œæ—" } } ] },
            4: { title: "3/16 (ä¸€) Day 4: å¤©ç©ºé³¥å±…èˆ‡çºœè»Š", highlights: ["å¤©ç©ºé³¥å±…", "Hoto Fudo", "å¤©ä¸Šå±±çºœè»Š"], stay: "HOTORI", timeline: [ { time: "09:00", icon: "â›©ï¸", title: "æ²³å£æ·ºé–“ç¥ç¤¾ (å¤©ç©ºé³¥å±…)", desc: "æ—©èµ·å‰å¾€é™æ‹œæ‰€ã€‚æ‹æ”å·¨å¤§é³¥å±…èˆ‡å¯Œå£«å±±çš„å¤¢å¹»åˆå½±ã€‚", hours: "9:00 - 16:00", cost: "å”åŠ›é‡‘ Â¥100", mapQuery: "Tenku no Torii", transport: { mode: "Taxi", route: "é£¯åº— -> é™æ‹œæ‰€", duration: "ç´„15åˆ†", note: "å»ºè­°ç›´æ¥å«è»Šä¸Šå±±" } }, { time: "11:30", icon: "ğŸœ", title: "Hoto Fudo (åŒ—æœ¬åº—)", desc: "ä¸‹å±±å¾Œï¼Œå‰å¾€é€™é–“è‘—åçš„é¤ºé£¥éºµé¤å»³äº«ç”¨åˆé¤ã€‚", hours: "11:00 - 20:00", cost: "Â¥1,210", mapQuery: "Hoto Fudo Kawaguchiko North Main Shop", transport: { mode: "Taxi/Walk", route: "é™æ‹œæ‰€ -> é¤å»³", duration: "10-15åˆ†", note: "è¨ˆç¨‹è»Šä¸‹å±±æœ€æ–¹ä¾¿" } }, { time: "14:00", icon: "ğŸš ", title: "æ²³å£æ¹–çºœè»Š", desc: "æ­ä¹˜çºœè»Šè‡³å¤©ä¸Šå±±å…¬åœ’ï¼Œä¿¯ç°æ²³å£æ¹–å…¨æ™¯ã€‚å¯ä»¥åƒçƒ¤ç³°å­ã€‚", hours: "9:30 - 16:00 (å¹³æ—¥)", cost: "ä¾†å› Â¥900", mapQuery: "Mt. Fuji Panoramic Ropeway", transport: { mode: "ç´…ç·šå·´å£«", route: "éŸ³æ¨‚ç›’ä¹‹æ£® -> éŠè¦½èˆ¹/çºœè»Šå£", duration: "ç´„15åˆ†", note: "é£¯åº—æ—æ­è»Š" } }, { time: "16:00", icon: "ğŸ¨", title: "ä¹…ä¿ç”°ä¸€ç«¹ç¾è¡“é¤¨", desc: "åƒè§€å’Œæœè—è¡“ (12-3æœˆé€±äºŒä¼‘é¤¨ï¼Œä»Šæ—¥é€±ä¸€æœ‰é–‹!)", hours: "10:00 - 16:30", cost: "Â¥1,300", mapQuery: "Itchiku Kubota Art Museum", transport: { mode: "ç´…ç·šå·´å£«", route: "çºœè»Š -> ç¾è¡“é¤¨", duration: "15åˆ†", note: "æ³¨æ„æœ€å¾Œå…¥é¤¨æ™‚é–“" } } ] },
            5: { title: "3/17 (äºŒ) Day 5: è¿”ç¨‹", highlights: ["å¯Œå£«å›éŠ", "N'EX", "IT203"], stay: "å®¶", timeline: [ { time: "11:00", icon: "ğŸ‘‹", title: "é€€æˆ¿ & å·´å£«", desc: "æ­ç´…ç·šå·´å£«å›æ²³å£æ¹–ç«™ã€‚", cost: "ç´„ Â¥400", mapQuery: "Kawaguchiko Station", transport: { mode: "ç´…ç·šå·´å£«", route: "é£¯åº— -> æ²³å£æ¹–ç«™", duration: "20åˆ†", note: "é ç•™æ™‚é–“é€›è»Šç«™" } }, { time: "13:00", icon: "ğŸš†", title: "å¯Œå£«å›éŠ", desc: "ç‰¹æ€¥ç›´é”æ–°å®¿ã€‚é€±äºŒç„¡åŠ ç­è»Šã€‚", cost: "Â¥4,130", mapQuery: "Shinjuku Station", transport: { mode: "å¯Œå£«å›éŠ", route: "æ²³å£æ¹– -> æ–°å®¿", duration: "2hr", note: "é ç´„ 12:04 (å›éŠ16) æˆ– 14:04 (å›éŠ20)" } }, { time: "17:00", icon: "ğŸ›«", title: "N'EX å¾€æ©Ÿå ´", desc: "æ–°å®¿è½‰ä¹˜ N'EXã€‚", cost: "Â¥3,270", mapQuery: "Narita International Airport", transport: { mode: "N'EX", route: "æ–°å®¿ -> æˆç”°", duration: "80åˆ†", note: "18:25 å‰æŠµé”æ«ƒæª¯" } }, { time: "20:25", icon: "âœˆï¸", title: "èµ·é£›è¿”å°", desc: "IT203 é£›å¾€ TPEã€‚", cost: "å·²ä»˜", mapQuery: "Narita International Airport", transport: { mode: "é£›è¡Œæ©Ÿ", route: "NRT -> TPE", duration: "4hr", note: "å†è¦‹äº†æ—¥æœ¬!" } } ] }
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const urlId = urlParams.get('id');
            if(urlId) document.getElementById('travel-id-input').value = urlId;
            checkLogin(urlId);
        });

        async function checkLogin(urlId = null) {
            const savedId = localStorage.getItem('nook_travel_id');
            const savedConfig = localStorage.getItem('nook_firebase_config');
            let envConfig = null;
            try { if(typeof __firebase_config !== 'undefined') envConfig = JSON.parse(__firebase_config); } catch(e){}
            let configToUse = savedConfig ? JSON.parse(savedConfig) : envConfig;

            if (urlId && configToUse) {
                appId = urlId;
                localStorage.setItem('nook_travel_id', urlId);
                showAppUI();
                await initFirebase(configToUse);
            } else if (savedId && configToUse) {
                appId = savedId;
                showAppUI();
                await initFirebase(configToUse);
            } else {
                document.getElementById('login-modal').classList.remove('hidden');
                if(envConfig) localStorage.setItem('nook_firebase_config', JSON.stringify(envConfig));
            }
        }

        function showAppUI() {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('main-nav').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('main-footer').classList.remove('hidden');
            document.getElementById('id-badge').innerText = `ID: ${appId}`;
            document.getElementById('footer-id').innerText = appId;
            switchView('dashboard');
            renderDay(1);
            renderTransportDetail('day3');
        }

        async function initFirebase(config) {
            try {
                if (!firebase.apps.length) firebase.initializeApp(config);
                auth = firebase.auth();
                db = firebase.firestore();
                await auth.signInAnonymously();
                
                // æ›´æ–°é€£ç·šç‹€æ…‹ç‡ˆ
                document.getElementById('connection-status').className = "w-3 h-3 rounded-full bg-green-500 border border-white animate-pulse";
                document.getElementById('connection-status').title = "å·²é€£ç·š";
                
                setupListeners();
            } catch (e) {
                console.error("Firebase Init Error:", e);
                document.getElementById('connection-status').className = "w-3 h-3 rounded-full bg-red-600 border border-white";
                alert(`âš ï¸ é€£ç·šå¤±æ•—: ${e.message}`);
                // å¦‚æœæ˜¯ API Key éŒ¯èª¤ï¼Œæç¤ºé‡è¨­
                if(e.code === "auth/invalid-api-key") {
                    localStorage.removeItem('nook_firebase_config');
                    location.reload();
                }
            }
        }

        function setupListeners() {
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('expenses')
                .orderBy('time', 'desc')
                .onSnapshot(snapshot => {
                    expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAccounting();
                    updateDashboard();
                }, err => {
                    console.error("Sync Error:", err);
                    document.getElementById('expense-list').innerHTML = `<div class="text-center text-red-400 py-10 font-bold">âš ï¸ é€£ç·šå¤±æ•—<br><span class="text-xs">è«‹ç¢ºèª Firebase å·²é–‹å•Ÿ Firestore ä¸”è¨­ç‚º Test Mode</span><br><span class="text-xs">${err.code}</span></div>`;
                });

            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('lists')
                .orderBy('time', 'asc')
                .onSnapshot(snapshot => {
                    const all = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    packList = all.filter(i => i.type === 'pack');
                    shopList = all.filter(i => i.type === 'shop');
                    renderLists();
                });
        }

        // --- Render Functions ---
        function renderDay(dayNum) {
            document.querySelectorAll('.day-tab').forEach(tab => { tab.classList.remove('bg-[#78B159]','text-white'); tab.classList.add('bg-[#FDFBF0]','text-gray-500'); });
            document.getElementById(`tab-day${dayNum}`).classList.remove('bg-[#FDFBF0]','text-gray-500');
            document.getElementById(`tab-day${dayNum}`).classList.add('bg-[#78B159]','text-white');
            const data = itineraryData[dayNum];
            const container = document.getElementById('day-content');
            let html = `<div class="mb-4"><h3 class="text-xl font-black text-[#7C5E45]">${data.title}</h3></div>`;
            data.timeline.forEach((item) => {
                const mapLink = item.mapQuery ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.mapQuery)}" target="_blank" class="nook-btn inline-flex items-center mt-3 px-3 py-1 bg-[#64C3D9] text-white text-xs hover:bg-[#4FA3B8] shadow-sm transform hover:rotate-1"><span class="mr-1">ğŸ—ºï¸</span> å°èˆª</a>` : '';
                let transportCard = '';
                if(item.transport) { transportCard = `<div class="transport-card"><div class="flex justify-between items-start mb-1"><span class="font-black text-[#006064] text-sm">${item.transport.mode}</span><span class="text-xs font-bold text-[#00838F] bg-white px-2 rounded-full border border-[#00838F]">${item.transport.duration}</span></div><div class="text-sm font-bold text-[#7C5E45] mb-1">${item.transport.route}</div><div class="text-xs text-[#0097A7]">ğŸ’¡ ${item.transport.note}</div></div>`; }
                html += `<div class="relative pl-8 pb-6 group"><div class="timeline-line"></div><div class="absolute left-0 top-1 w-8 h-8 bg-[#FDFBF0] border-4 border-[#78B159] rounded-full flex items-center justify-center z-10 shadow-sm text-sm">${item.icon}</div><div class="bg-white p-4 rounded-2xl border-2 border-[#E0E0E0] shadow-sm hover:border-[#78B159] transition-colors h-full flex flex-col"><div class="flex justify-between items-baseline mb-1"><span class="font-black text-[#7C5E45] text-lg">${item.title}</span><span class="font-bold text-[#78B159] text-sm bg-[#F1F8E9] px-2 py-0.5 rounded-lg">${item.time}</span></div><p class="text-sm text-[#594A3D] mb-2 font-medium">${item.desc}</p><div class="flex flex-wrap gap-2 mb-2"><div class="text-xs text-[#E65100] font-bold bg-[#FFF3E0] inline-block px-2 py-1 rounded">ğŸ’° è²»ç”¨: ${item.cost}</div></div><div class="flex flex-col mt-auto">${transportCard}<div class="mt-1">${mapLink}</div></div></div></div>`;
            });
            container.innerHTML = html;
        }

        function renderTransportDetail(type) {
            const container = document.getElementById('transport-detail-container');
            if(type === 'day3') { container.innerHTML = `<div class="nook-card p-6 bg-[#FFFDE7] border-l-8 border-[#F7E464]"><h3 class="font-black text-xl text-[#7C5E45] mb-4 flex items-center"><span class="text-2xl mr-2">ğŸšŒ</span> Day 3: çŸ³å’Œæº«æ³‰ â” æ²³å£æ¹–</h3><p class="text-sm mb-4 font-bold text-[#594A3D]">é—œéµç­æ¬¡ï¼š<span class="text-[#E65100] text-lg">10:08</span> ç™¼è»Šã€‚éŒ¯éè¦ç­‰å¾ˆä¹…ï¼</p><div class="bg-white p-4 rounded-xl border-2 border-[#FFF9C4] mb-4"><h4 class="font-bold text-[#FBC02D] mb-2">ğŸ“ å€™è»Šè™•</h4><p class="text-sm text-[#7C5E45]">çŸ³å’Œæº«æ³‰ç«™ <strong>å—å£</strong> å·´å£«åœ“ç’°ï¼Œ1è™Ÿæˆ–2è™Ÿä¹˜è»Šè™•ã€‚</p></div></div>`; } 
            else if(type === 'local') { container.innerHTML = `<div class="nook-card p-6 bg-[#E0F7FA] border-l-8 border-[#64C3D9]"><h3 class="font-black text-xl text-[#006064] mb-4 flex items-center"><span class="text-2xl mr-2">ğŸ—ºï¸</span> æ²³å£æ¹–å‘¨éŠå·´å£«</h3><div class="bus-route-container"><div class="bus-label-top text-[#E53935] font-black">ğŸ”´ ç´…ç·š (Red Line)</div><div class="bus-line-red"></div><div class="bus-stop" style="left: 10%;"></div><div class="bus-label" style="left: 10%; color:#555;"><strong>æ²³å£æ¹–ç«™</strong></div><div class="bus-stop active" style="left: 65%;"></div><div class="bus-label" style="left: 65%; color: #004D40; font-black;">â˜… é£¯åº—</div><div class="bus-stop" style="left: 90%;"></div><div class="bus-label" style="left: 90%; color:#555;"><strong>å¤§çŸ³å…¬åœ’</strong></div></div></div>`; } 
            else { container.innerHTML = `<div class="bg-[#FFF3E0] border-2 border-[#FFB74D] p-6 rounded-xl"><h3 class="text-xl font-bold text-[#E65100] mb-2">ğŸš† å¯Œå£«å›éŠ (è¿”ç¨‹)</h3><p class="text-sm text-[#E65100] mb-2">Day 5 ç›´é”æ–°å®¿ï¼Œå…¨è»ŠæŒ‡å®šå¸­ï¼Œå»ºè­°ææ—© 1 å€‹æœˆè¨‚ç¥¨ã€‚</p><ul class="text-sm text-gray-700 font-bold"><li>12:04 ç™¼è»Š (å›éŠ 16 è™Ÿ)</li><li>14:04 ç™¼è»Š (å›éŠ 20 è™Ÿ)</li></ul></div>`; }
        }

        // --- Common UI Functions ---
        function saveTravelId() {
            const id = document.getElementById('travel-id-input').value.trim();
            const configStored = localStorage.getItem('nook_firebase_config');
            if (!configStored) { alert('âš ï¸ è«‹å…ˆè¨­å®šä¸‹æ–¹çš„é›²ç«¯è³‡æ–™åº« (Firebase Config)ï¼'); document.getElementById('config-panel').classList.remove('hidden'); return; }
            if (!id) { alert('è«‹è¼¸å…¥ä»£ç¢¼ (ä¾‹å¦‚: Trip2026)'); return; }
            localStorage.setItem('nook_travel_id', id);
            location.href = window.location.pathname; 
        }

        function copyShareLink() {
            if (!appId) return;
            const url = window.location.href.split('?')[0] + '?id=' + appId;
            navigator.clipboard.writeText(url).then(() => { const toast = document.getElementById("toast"); toast.className = "show"; setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000); }).catch(err => { alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ç¶²å€ï¼š\n' + url); });
        }

        function toggleConfigPanel() { document.getElementById('config-panel').classList.toggle('hidden'); const existing = localStorage.getItem('nook_firebase_config'); if(existing) document.getElementById('config-input').value = existing; }

        function saveConfig() {
            let raw = document.getElementById('config-input').value.trim();
            try {
                // 1. å»é™¤è¨»è§£
                raw = raw.replace(/\/\/.*$/gm, ''); 
                // 2. æ“·å–ç‰©ä»¶éƒ¨åˆ†
                if(raw.includes('=')) raw = raw.substring(raw.indexOf('=') + 1).trim();
                if(raw.endsWith(';')) raw = raw.slice(0, -1).trim();
                // 3. ä¿®å¾© Key å¼•è™Ÿ
                let jsonString = raw.replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:/g, '"$2":');
                // 4. ä¿®å¾©å°¾éš¨é€—è™Ÿ
                jsonString = jsonString.replace(/,(\s*})/g, '$1');
                // 5. ç¢ºä¿å¤§æ‹¬è™Ÿ
                if (!jsonString.startsWith('{')) jsonString = '{' + jsonString + '}';

                const config = JSON.parse(jsonString); 
                localStorage.setItem('nook_firebase_config', JSON.stringify(config));
                alert('âœ… è¨­å®šå·²å„²å­˜ï¼è«‹è¼¸å…¥ä»£ç¢¼é–‹å§‹ä½¿ç”¨ã€‚'); document.getElementById('config-panel').classList.add('hidden'); setTimeout(() => location.reload(), 500);
            } catch(e) { console.error(e); alert('âŒ æ ¼å¼ç„¡æ³•è¾¨è­˜ï¼\nè«‹ç¢ºèªæ‚¨è¤‡è£½çš„æ˜¯ Firebase çµ¦çš„é‚£æ®µå®Œæ•´ç¨‹å¼ç¢¼ã€‚\n\néŒ¯èª¤è©³æƒ…: ' + e.message); }
        }

        function logout() { if(confirm('è¦ç™»å‡ºä¸¦æ›´æ›ä»£ç¢¼å—ï¼Ÿ')) { localStorage.removeItem('nook_travel_id'); window.location.href = window.location.pathname; } }
        function addExpense() { const cat = document.getElementById('acc-cat').value; const item = document.getElementById('acc-item').value; const amt = parseFloat(document.getElementById('acc-amt').value); const curr = document.getElementById('acc-curr').value; if(!item || !amt) return; db.collection('artifacts').doc(appId).collection('public').doc('data').collection('expenses').add({ time: Date.now(), cat, item, amt, curr }); document.getElementById('acc-item').value = ''; document.getElementById('acc-amt').value = ''; }
        function delExpense(id) { if(confirm('ç¢ºå®šåˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ')) { db.collection('artifacts').doc(appId).collection('public').doc('data').collection('expenses').doc(id).delete(); } }
        function renderAccounting() { const list = document.getElementById('expense-list'); list.innerHTML = ''; if(expenses.length === 0) { list.innerHTML = `<div class="text-center text-gray-400 py-10">é€™è£¡é‚„ç©ºç©ºçš„ï¼Œé–‹å§‹è¨˜å¸³å§ï¼</div>`; return; } expenses.forEach(ex => { const twd = ex.curr === 'JPY' ? Math.round(ex.amt * RATE) : ex.amt; const idParam = `'${ex.id}'`; list.innerHTML += `<div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition"><div class="flex items-center"><span class="w-10 h-10 rounded-full bg-[#F1F8E9] text-xl flex items-center justify-center mr-3 select-none">${ex.cat.substring(0,2)}</span><div><div class="font-bold text-[#594A3D]">${ex.item}</div><div class="text-xs text-gray-400">${ex.amt} ${ex.curr}</div></div></div><div class="flex items-center"><span class="font-bold text-[#E65100] mr-4">$${twd}</span><button onclick="delExpense(${idParam})" class="text-gray-300 hover:text-red-500 font-bold px-2">Ã—</button></div></div>`; }); }
        function addListItem() { const val = document.getElementById('list-input').value; if(!val) return; db.collection('artifacts').doc(appId).collection('public').doc('data').collection('lists').add({ time: Date.now(), text: val, type: listMode, checked: false }); document.getElementById('list-input').value = ''; }
        function delListItem(id) { db.collection('artifacts').doc(appId).collection('public').doc('data').collection('lists').doc(id).delete(); }
        function renderLists() { const container = document.getElementById('list-container'); const btnPack = document.getElementById('btn-pack'); const btnShop = document.getElementById('btn-shop'); if(listMode === 'pack') { btnPack.className = "flex-1 py-2 rounded-lg font-bold transition bg-[#FFF3E0] text-[#E65100]"; btnShop.className = "flex-1 py-2 rounded-lg font-bold transition text-gray-500 hover:bg-gray-50"; } else { btnShop.className = "flex-1 py-2 rounded-lg font-bold transition bg-[#E0F2F1] text-[#00695C]"; btnPack.className = "flex-1 py-2 rounded-lg font-bold transition text-gray-500 hover:bg-gray-50"; } container.innerHTML = ''; const currentList = listMode === 'pack' ? packList : shopList; if(currentList.length === 0) { container.innerHTML = `<div class="col-span-1 md:col-span-2 text-center text-gray-400 py-6">æ¸…å–®æ˜¯ç©ºçš„</div>`; return; } currentList.forEach(item => { const idParam = `'${item.id}'`; container.innerHTML += `<div class="flex items-center justify-between bg-white p-4 rounded-xl border border-gray-100 hover:shadow-md transition"><span class="font-bold text-gray-700 ml-2">${item.text}</span><button onclick="delListItem(${idParam})" class="text-gray-300 hover:text-red-500 font-bold px-2">Ã—</button></div>`; }); }
        function updateDashboard() { let varTotal = 0; expenses.forEach(e => { varTotal += (e.curr === 'JPY' ? Math.round(e.amt * RATE) : parseFloat(e.amt)); }); document.getElementById('variable-spent').innerText = new Intl.NumberFormat().format(varTotal); document.getElementById('total-spent').innerText = new Intl.NumberFormat().format(FIXED_COST + varTotal); const total = FIXED_COST + varTotal; if(total > 0) { const varPercent = Math.min((varTotal / total) * 100, 100); document.getElementById('variable-bar').style.width = varPercent + '%'; } }
        function switchView(viewId) { document.querySelectorAll('main > section').forEach(el => { el.classList.add('hidden'); el.classList.remove('fade-in'); }); const target = document.getElementById(`view-${viewId}`); if(target) { target.classList.remove('hidden'); void target.offsetWidth; target.classList.add('fade-in'); window.scrollTo(0,0); } document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active')); const navBtn = document.getElementById(`nav-${viewId}`); if(navBtn) navBtn.classList.add('active'); if(viewId === 'dashboard') updateDashboard(); }
        function closeMenu() { document.getElementById('mobile-menu').classList.add('hidden'); }
    </script>
</body>
</html>
