<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 å±±æ¢¨ç”²æ–æ—… (å…±ç”¨ç¶²é ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;800&display=swap" rel="stylesheet">
    
    <!-- ç¶²ç«™åœ–ç¤º (Favicon) -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EğŸƒ%3C/text%3E%3C/svg%3E">

    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --ac-green: #78B159; --ac-cream: #FDFBF0; --ac-brown: #7C5E45; --ac-text: #594A3D; }
        body { font-family: 'M PLUS Rounded 1c', sans-serif; background-color: var(--ac-cream); color: var(--ac-text); background-image: radial-gradient(#E6F2D6 15%, transparent 16%), radial-gradient(#E6F2D6 15%, transparent 16%); background-size: 30px 30px; background-position: 0 0, 15px 15px; }
        
        /* é€šç”¨å¡ç‰‡æ¨£å¼ */
        .nook-card { background-color: white; border-radius: 1rem; box-shadow: 4px 4px 0 rgba(124, 94, 69, 0.1); border: 2px solid #E0E0E0; transition: transform 0.2s; }
        .nook-card:hover { transform: translateY(-2px); box-shadow: 6px 6px 0 rgba(124, 94, 69, 0.15); }
        
        /* æŒ‰éˆ•èˆ‡æ¨™ç±¤ */
        .nook-btn { border-radius: 9999px; font-weight: 800; transition: all 0.2s; cursor: pointer; }
        .nook-btn:active { transform: scale(0.95); }
        .leaf-icon { display: inline-block; width: 1.2em; height: 1.2em; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2378B159'%3E%3Cpath d='M12 2C9 2 4 5 4 10C4 13 6 15 8 16L9 22H11L10 16.5C10 16.5 13 17 15 15C18 12 20 8 20 5C20 3 18 2 12 2ZM12 4C16 4 17 7 15 10C13 13 10 14 10 14C10 14 11.5 10 9 7C7 5 5 6 5 6C5 6 7 4 12 4Z'/%3E%3C/svg%3E"); background-size: contain; background-repeat: no-repeat; vertical-align: middle; }

        /* å°è¦½åˆ— */
        .nav-link { cursor: pointer; padding: 0.5rem 1rem; border-radius: 9999px; font-weight: bold; color: white; opacity: 0.8; transition: all 0.2s; }
        .nav-link:hover, .nav-link.active { background-color: rgba(255,255,255,0.2); opacity: 1; }
        
        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: flex; justify-content: center; align-items: center; padding: 1rem; backdrop-filter: blur(4px); }
        .modal-content { background: #FDFBF0; border-radius: 1.5rem; padding: 2rem; width: 100%; max-width: 400px; border: 4px solid #F7E464; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        
        /* Toast Notification */
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 30px; font-size: 14px; opacity: 0; transition: opacity 0.5s, bottom 0.5s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Toast Notification -->
    <div id="toast">å·²è¤‡è£½é€£çµï¼</div>

    <!-- ç™»å…¥èˆ‡è¨­å®šé®ç½© -->
    <div id="login-modal" class="modal">
        <div class="modal-content text-center">
            <div class="w-20 h-20 bg-white rounded-full mx-auto mb-4 flex items-center justify-center border-4 border-[#78B159] shadow-sm">
                <span class="leaf-icon w-12 h-12"></span>
            </div>
            <h2 class="text-2xl font-black text-[#7C5E45] mb-2">é–‹å§‹æ—…ç¨‹</h2>
            <p class="text-sm text-gray-500 mb-6 font-bold">è«‹è¼¸å…¥ã€Œæ—…è²»ä»£ç¢¼ã€èˆ‡æ—…ä¼´åŒæ­¥è³‡æ–™</p>
            
            <div class="space-y-4">
                <input type="text" id="travel-id-input" placeholder="è¨­å®šä¸€å€‹ä»£ç¢¼ (ä¾‹: Trip2026)" class="w-full bg-white border-2 border-gray-300 rounded-xl p-3 text-center font-bold text-lg text-[#7C5E45] outline-none focus:border-[#78B159]">
                <button onclick="saveTravelId()" class="w-full bg-[#78B159] text-white font-black py-3 rounded-xl shadow-md nook-btn text-lg hover:bg-[#689F4D]">ğŸš€ é€²å…¥ç¶²ç«™</button>
            </div>

            <div class="mt-8 pt-4 border-t border-gray-200">
                <button onclick="toggleConfigPanel()" class="text-xs text-gray-400 font-bold underline hover:text-gray-600">ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Ÿè«‹å…ˆé»æ­¤è¨­å®šé›²ç«¯è³‡æ–™åº«</button>
            </div>
            
            <!-- Config è¨­å®šå€ (é è¨­éš±è—) -->
            <div id="config-panel" class="hidden mt-4 text-left bg-gray-50 p-3 rounded-lg border border-gray-200">
                <p class="text-xs text-gray-500 mb-2 font-bold">è«‹è²¼ä¸Š Firebase Config (JSONæ ¼å¼):</p>
                <textarea id="config-input" class="w-full h-24 text-[10px] bg-white p-2 rounded border border-gray-300 font-mono mb-2" placeholder='const firebaseConfig = { ... }'></textarea>
                <button onclick="saveConfig()" class="w-full bg-[#F7E464] text-[#7C5E45] font-bold py-2 rounded-lg text-sm hover:bg-[#FFD54F]">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>

    <!-- é ‚éƒ¨å°è¦½åˆ— -->
    <nav class="bg-[#78B159] shadow-md sticky top-0 z-50 hidden" id="main-nav">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-2 cursor-pointer" onclick="switchView('dashboard')">
                    <div class="w-10 h-10 bg-[#FDFBF0] rounded-full flex items-center justify-center border-2 border-[#F7E464] transform -rotate-12">
                        <span class="leaf-icon"></span>
                    </div>
                    <span class="font-extrabold text-xl text-[#FDFBF0] tracking-wider hidden sm:block">Nook Travel</span>
                </div>
                
                <!-- é›»è…¦ç‰ˆé¸å–® -->
                <div class="hidden md:flex space-x-1">
                    <a onclick="switchView('dashboard')" class="nav-link active" id="nav-dashboard">ç¸½è¦½</a>
                    <a onclick="switchView('accounting')" class="nav-link" id="nav-accounting">è¨˜å¸³</a>
                    <a onclick="switchView('lists')" class="nav-link" id="nav-lists">æ¸…å–®</a>
                    <a onclick="switchView('itinerary')" class="nav-link" id="nav-itinerary">è¡Œç¨‹</a>
                    <a onclick="switchView('transport')" class="nav-link" id="nav-transport">äº¤é€š</a>
                </div>

                <!-- æ‰‹æ©Ÿç‰ˆæ¼¢å ¡é¸å–®æŒ‰éˆ• -->
                <div class="md:hidden">
                    <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="text-white font-bold p-2">
                        <span class="text-2xl">â˜°</span>
                    </button>
                </div>

                <div class="flex items-center ml-4">
                     <span class="text-xs bg-black/20 text-white px-3 py-1 rounded-full font-bold cursor-pointer hover:bg-black/30 transition" onclick="logout()" id="id-badge">ID: --</span>
                </div>
            </div>
        </div>
        <!-- æ‰‹æ©Ÿç‰ˆä¸‹æ‹‰é¸å–® -->
        <div id="mobile-menu" class="hidden md:hidden bg-[#689F4D] p-2">
            <a onclick="switchView('dashboard'); closeMenu()" class="block px-4 py-2 text-white font-bold hover:bg-black/10 rounded">ğŸ“Š ç¸½è¦½</a>
            <a onclick="switchView('accounting'); closeMenu()" class="block px-4 py-2 text-white font-bold hover:bg-black/10 rounded">ğŸ’° è¨˜å¸³</a>
            <a onclick="switchView('lists'); closeMenu()" class="block px-4 py-2 text-white font-bold hover:bg-black/10 rounded">ğŸ“ æ¸…å–®</a>
            <a onclick="switchView('itinerary'); closeMenu()" class="block px-4 py-2 text-white font-bold hover:bg-black/10 rounded">ğŸ“… è¡Œç¨‹</a>
            <a onclick="switchView('transport'); closeMenu()" class="block px-4 py-2 text-white font-bold hover:bg-black/10 rounded">ğŸšŒ äº¤é€š</a>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main id="main-content" class="container mx-auto px-4 py-6 max-w-4xl flex-grow hidden">
        
        <!-- ç¸½è¦½é é¢ -->
        <section id="view-dashboard" class="space-y-6 fade-in">
            <div class="text-center mb-6">
                <h1 class="text-2xl md:text-3xl font-black text-[#7C5E45] mb-2">2026 å±±æ¢¨ç”²æ–ãƒ»éœè¬ä¹‹æ—…</h1>
                <div class="flex justify-center gap-2 mb-2">
                    <p class="text-sm text-gray-500 font-bold bg-white inline-block px-3 py-1 rounded-full border border-gray-200">å…©äººåŒè¡Œ â€¢ No Beef â€¢ é›²ç«¯åŒæ­¥</p>
                </div>
                <!-- åˆ†äº«æŒ‰éˆ• -->
                <button onclick="copyShareLink()" class="text-xs bg-[#78B159] text-white px-3 py-1.5 rounded-full font-bold shadow-sm hover:bg-[#689F4D] transition flex items-center justify-center mx-auto">
                    ğŸ”— è¤‡è£½é‚€è«‹é€£çµ
                </button>
            </div>

            <div class="nook-card p-6 border-t-8 border-[#F7E464]">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                    <h2 class="text-xl font-black text-[#7C5E45] flex items-center mb-2 md:mb-0"><span class="text-2xl mr-2">ğŸ’°</span> é ç®—ç›£æ§</h2>
                    <div class="text-right">
                        <span class="text-sm text-gray-500 font-bold">ç¸½èŠ±è²» (TWD)</span>
                        <div class="text-3xl font-black text-[#E65100]" id="total-spent">--</div>
                    </div>
                </div>
                <!-- é€²åº¦æ¢ -->
                <div class="w-full bg-gray-100 rounded-full h-4 mb-4 overflow-hidden shadow-inner">
                    <div class="bg-[#78B159] h-4 inline-block" style="width: 40%" title="å›ºå®šæ”¯å‡º"></div><div class="bg-[#FFB74D] h-4 inline-block transition-all duration-500" id="variable-bar" style="width: 0%" title="æµ®å‹•æ”¯å‡º"></div>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm font-bold text-gray-600 bg-gray-50 p-4 rounded-xl">
                    <div>âœˆï¸ å›ºå®šæ”¯å‡º (æ©Ÿ+é…’): <span class="text-[#78B159]">36,046</span></div>
                    <div>ğŸ± æµ®å‹•æ”¯å‡º (åƒå–ç©æ¨‚): <span class="text-[#E65100]" id="variable-spent">0</span></div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div onclick="switchView('accounting')" class="nook-card p-6 flex items-center justify-between cursor-pointer hover:bg-[#FFFDE7]">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-[#FFF9C4] rounded-full flex items-center justify-center text-2xl mr-4">ğŸ“</div>
                        <div>
                            <h3 class="font-bold text-[#7C5E45]">è¨˜ä¸€ç­†</h3>
                            <p class="text-xs text-gray-400">ç´€éŒ„ç•¶ä¸‹æ¶ˆè²»</p>
                        </div>
                    </div>
                    <span class="text-[#E65100] font-black text-xl">â†’</span>
                </div>
                <div onclick="switchView('lists')" class="nook-card p-6 flex items-center justify-between cursor-pointer hover:bg-[#E0F2F1]">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-[#B2DFDB] rounded-full flex items-center justify-center text-2xl mr-4">ğŸ’</div>
                        <div>
                            <h3 class="font-bold text-[#00695C]">è¡Œæèˆ‡è³¼ç‰©</h3>
                            <p class="text-xs text-gray-400">æª¢æŸ¥å¿…å¸¶ç‰©å“</p>
                        </div>
                    </div>
                    <span class="text-[#00695C] font-black text-xl">â†’</span>
                </div>
            </div>
        </section>

        <!-- è¨˜å¸³é é¢ -->
        <section id="view-accounting" class="hidden space-y-6 fade-in">
            <h2 class="text-2xl font-black text-[#7C5E45] border-l-4 border-[#78B159] pl-3">æ—…è²»è¨˜å¸³æœ¬</h2>
            
            <div class="nook-card p-6 bg-[#FDFBF0] border-2 border-[#F7E464]">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 mb-3">
                    <div class="md:col-span-2">
                        <label class="text-xs font-bold text-gray-500 pl-1">é¡åˆ¥</label>
                        <select id="acc-cat" class="w-full p-3 rounded-xl border border-gray-200 font-bold text-[#558B2F] bg-white outline-none focus:border-[#78B159]">
                            <option>ğŸ± é£Ÿ</option><option>ğŸš† è¡Œ</option><option>ğŸŸï¸ æ¨‚</option><option>ğŸ›ï¸ è²·</option><option>ğŸ¨ ä½</option>
                        </select>
                    </div>
                    <div class="md:col-span-6">
                        <label class="text-xs font-bold text-gray-500 pl-1">é …ç›®åç¨±</label>
                        <input type="text" id="acc-item" placeholder="ä¾‹å¦‚: é¤ºé£¥éºµåˆé¤" class="w-full p-3 rounded-xl border border-gray-200 bg-white outline-none focus:border-[#78B159]">
                    </div>
                    <div class="md:col-span-4">
                        <label class="text-xs font-bold text-gray-500 pl-1">é‡‘é¡</label>
                        <div class="flex">
                            <input type="number" id="acc-amt" placeholder="0" class="w-full p-3 rounded-l-xl border border-gray-200 border-r-0 bg-white outline-none focus:border-[#78B159]">
                            <select id="acc-curr" class="bg-[#FFF9C4] border border-gray-200 border-l-0 rounded-r-xl px-2 font-bold text-[#E65100] outline-none">
                                <option value="JPY">Â¥ JPY</option><option value="TWD">$ TWD</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button onclick="addExpense()" class="w-full bg-[#78B159] text-white font-bold py-3 rounded-xl shadow hover:bg-[#689F4D] transition">ï¼‹ æ–°å¢ç´€éŒ„</button>
            </div>

            <div id="expense-list" class="space-y-3">
                <div class="text-center text-gray-400 py-10">è³‡æ–™è®€å–ä¸­...</div>
            </div>
        </section>

        <!-- æ¸…å–®é é¢ -->
        <section id="view-lists" class="hidden space-y-6 fade-in">
            <h2 class="text-2xl font-black text-[#7C5E45] border-l-4 border-[#64C3D9] pl-3">æª¢æŸ¥æ¸…å–®</h2>
            
            <div class="flex space-x-2 bg-white p-1 rounded-xl shadow-sm border border-gray-200">
                <button onclick="listMode='pack'; renderLists()" id="btn-pack" class="flex-1 py-2 rounded-lg font-bold transition bg-[#FFF3E0] text-[#E65100]">ğŸ’ å‡ºç™¼å¿…å¸¶</button>
                <button onclick="listMode='shop'; renderLists()" id="btn-shop" class="flex-1 py-2 rounded-lg font-bold text-gray-500 hover:bg-gray-50 transition">ğŸ›ï¸ è³¼ç‰©é¡˜æœ›</button>
            </div>

            <div class="flex gap-2">
                <input type="text" id="list-input" class="flex-grow p-3 rounded-xl border-2 border-gray-200 outline-none focus:border-[#64C3D9]" placeholder="æ–°å¢å¾…è¾¦äº‹é …...">
                <button onclick="addListItem()" class="bg-[#64C3D9] text-white px-6 rounded-xl font-bold text-xl shadow hover:bg-[#4FA3B8]">+</button>
            </div>

            <div id="list-container" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <!-- Javascript will populate this -->
            </div>
        </section>

        <!-- è¡Œç¨‹é é¢ -->
        <section id="view-itinerary" class="hidden space-y-6 fade-in">
            <h2 class="text-2xl font-black text-[#7C5E45] border-l-4 border-[#F7E464] pl-3">æ¯æ—¥è¡Œç¨‹</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Day 1 -->
                <div class="nook-card p-4 h-full">
                    <div class="bg-[#78B159] text-white py-1 px-3 rounded-lg inline-block text-xs font-bold mb-2">3/13 (äº”) Day 1</div>
                    <h3 class="font-black text-lg text-[#594A3D] mb-3">å•Ÿç¨‹èˆ‡æº«æ³‰</h3>
                    <ul class="space-y-3">
                        <li class="flex items-start"><span class="text-xl mr-2">ğŸ›¬</span><div><span class="font-bold block">10:35 æŠµé”æˆç”°</span><span class="text-xs text-gray-500">IT200 / é ˜å– JR Pass</span></div></li>
                        <li class="flex items-start"><span class="text-xl mr-2">ğŸš†</span><div><span class="font-bold block">11:44 N'EX å¾€æ–°å®¿</span><span class="text-xs text-gray-500">è½‰ä¹˜ Kaiji ç‰¹æ€¥ (13:30)</span></div></li>
                        <li class="flex items-start"><span class="text-xl mr-2">ğŸ¡</span><div><span class="font-bold block">15:00 å¤æ°‘å®¶ Check-in</span><span class="text-xs text-gray-500">çŸ³å’Œæº«æ³‰ç«™æ­è¨ˆç¨‹è»Š</span></div></li>
                    </ul>
                </div>
                <!-- Day 2 -->
                <div class="nook-card p-4 h-full">
                    <div class="bg-[#78B159] text-white py-1 px-3 rounded-lg inline-block text-xs font-bold mb-2">3/14 (å…­) Day 2</div>
                    <h3 class="font-black text-lg text-[#594A3D] mb-3">æ­·å²èˆ‡è‡ªç„¶</h3>
                    <ul class="space-y-3">
                        <li class="flex items-start"><span class="text-xl mr-2">ğŸ¯</span><div><span class="font-bold block">09:00 æƒ æ—å¯º</span><span class="text-xs text-gray-500">æ­¦ç”°ä¿¡ç„é•·çœ ä¹‹åœ°</span></div></li>
                        <li class="flex items-start"><span class="text-xl mr-2">ğŸ“</span><div><span class="font-bold block">11:00 è‰è“åƒåˆ°é£½</span><span class="text-xs text-gray-500">Gourmet è‹ºå‰ç”° (é ç´„åˆ¶)</span></div></li>
                        <li class="flex items-start"><span class="text-xl mr-2">ğŸï¸</span><div><span class="font-bold block">13:30 æ˜‡ä»™å³½</span><span class="text-xs text-gray-500">çµ•ç¾æºªè°·æ•£ç­–</span></div></li>
                    </ul>
                </div>
                <!-- Day 3 -->
                <div class="nook-card p-4 h-full border-2 border-[#E65100]">
                    <div class="bg-[#E65100] text-white py-1 px-3 rounded-lg inline-block text-xs font-bold mb-2">3/15 (æ—¥) Day 3 â˜…ç§»å‹•æ—¥</div>
                    <h3 class="font-black text-lg text-[#594A3D] mb-3">å‰é€²æ²³å£æ¹–</h3>
                    <ul class="space-y-3">
                        <li class="flex items-start bg-[#FFF3E0] p-2 rounded-lg"><span class="text-xl mr-2">ğŸšŒ</span><div><span class="font-bold block text-[#E65100]">10:08 ç›´é”å·´å£« (å¿…æ­)</span><span class="text-xs text-[#E65100]">çŸ³å’Œæº«æ³‰å—å£ç™¼è»Š</span></div></li>
                        <li class="flex items-start"><span class="text-xl mr-2">ğŸ˜ï¸</span><div><span class="font-bold block">12:00 è¥¿æ¹–ç™‚ç™’ä¹‹é‡Œæ ¹å ´</span><span class="text-xs text-gray-500">ç¶ ç·šå·´å£« / åˆæŒé€ å»ºç¯‰</span></div></li>
                        <li class="flex items-start"><span class="text-xl mr-2">ğŸ¨</span><div><span class="font-bold block">16:30 å…¥ä½ HOTORI</span><span class="text-xs text-gray-500">å¤§çŸ³å…¬åœ’æ— / å¯Œå£«å±±æ™¯</span></div></li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- äº¤é€šé é¢ -->
        <section id="view-transport" class="hidden space-y-6 fade-in">
            <h2 class="text-2xl font-black text-[#7C5E45] border-l-4 border-[#64C3D9] pl-3">äº¤é€šæ”»ç•¥</h2>
            <div class="bg-[#E0F7FA] border-2 border-[#64C3D9] p-6 rounded-xl">
                <h3 class="text-xl font-bold text-[#006064] mb-2">ğŸšŒ æ²³å£æ¹–å‘¨éŠå·´å£«</h3>
                <div class="flex items-center justify-between text-sm font-bold text-gray-600 mb-4">
                    <span>æ²³å£æ¹–ç«™</span>
                    <span class="flex-grow border-b-4 border-dotted border-[#64C3D9] mx-2 relative top-[-4px]"></span>
                    <span>å¤§çŸ³å…¬åœ’</span>
                </div>
                <p class="text-sm text-[#006064]">
                    ğŸ”´ <span class="font-black">ç´…ç·š (Red Line)</span>ï¼šæ¯ 15 åˆ†é˜ä¸€ç­ï¼Œå‰å¾€é£¯åº—ã€ç¾è¡“é¤¨ã€çºœè»Šã€‚<br>
                    ğŸŸ¢ <span class="font-black">ç¶ ç·š (Green Line)</span>ï¼šå‰å¾€è¥¿æ¹–æ ¹å ´ï¼Œç­æ¬¡è¼ƒå°‘è«‹æ³¨æ„ã€‚
                </p>
            </div>
            
            <div class="bg-[#FFF3E0] border-2 border-[#FFB74D] p-6 rounded-xl">
                <h3 class="text-xl font-bold text-[#E65100] mb-2">ğŸš† å¯Œå£«å›éŠ (è¿”ç¨‹)</h3>
                <p class="text-sm text-[#E65100] mb-2">Day 5 ç›´é”æ–°å®¿ï¼Œå…¨è»ŠæŒ‡å®šå¸­ï¼Œå»ºè­°ææ—© 1 å€‹æœˆè¨‚ç¥¨ã€‚</p>
                <ul class="text-sm text-gray-700 font-bold">
                    <li>12:04 ç™¼è»Š (å›éŠ 16 è™Ÿ)</li>
                    <li>14:04 ç™¼è»Š (å›éŠ 20 è™Ÿ)</li>
                </ul>
            </div>
        </section>

    </main>

    <footer class="bg-[#78B159] text-white py-6 mt-auto hidden text-center text-sm font-bold" id="main-footer">
        Â© 2026 å±±æ¢¨ç”²æ–æ—… | å…±ç”¨ä»£ç¢¼: <span id="footer-id">--</span>
    </footer>

    <script>
        // --- æ ¸å¿ƒè®Šæ•¸èˆ‡è¨­å®š ---
        const FIXED_COST = 36046; // æ©Ÿç¥¨ + ä½å®¿
        const RATE = 0.215; // åŒ¯ç‡
        let db, auth;
        let appId = null; // é€™å°±æ˜¯ã€Œæ—…è²»ä»£ç¢¼ã€
        let expenses = [];
        let packList = [];
        let shopList = [];
        let listMode = 'pack';

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', async () => {
            // æª¢æŸ¥ç¶²å€åƒæ•¸æ˜¯å¦æœ‰ ID (æ–°åŠŸèƒ½)
            const urlParams = new URLSearchParams(window.location.search);
            const urlId = urlParams.get('id');
            if(urlId) {
                // å¦‚æœç¶²å€å¸¶æœ‰ IDï¼Œå„ªå…ˆä½¿ç”¨ä¸¦å¡«å…¥è¼¸å…¥æ¡†
                document.getElementById('travel-id-input').value = urlId;
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰å„²å­˜çš„ Config èˆ‡ ID
            checkLogin(urlId);
        });

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        async function checkLogin(urlId = null) {
            const savedId = localStorage.getItem('nook_travel_id');
            const savedConfig = localStorage.getItem('nook_firebase_config');

            // é è¦½ç’°å¢ƒè‡ªå‹•å¸¶å…¥
            let envConfig = null;
            try { if(typeof __firebase_config !== 'undefined') envConfig = JSON.parse(__firebase_config); } catch(e){}

            // å„ªå…ˆä½¿ç”¨ localStorageï¼Œæ²’æœ‰å‰‡ä½¿ç”¨ç’°å¢ƒè®Šæ•¸
            let configToUse = savedConfig ? JSON.parse(savedConfig) : envConfig;

            // é‚è¼¯ï¼šå¦‚æœæœ‰ç¶²å€ ID ä¸”æœ‰ Configï¼Œç›´æ¥è‡ªå‹•ç™»å…¥ä¸¦å„²å­˜
            if (urlId && configToUse) {
                appId = urlId;
                localStorage.setItem('nook_travel_id', urlId);
                showAppUI();
                await initFirebase(configToUse);
            }
            // å¦å‰‡èµ°åŸæœ¬é‚è¼¯
            else if (savedId && configToUse) {
                appId = savedId;
                showAppUI();
                await initFirebase(configToUse);
            } else {
                // ç„¡è³‡æ–™ï¼Œé¡¯ç¤ºç™»å…¥é®ç½©
                document.getElementById('login-modal').classList.remove('hidden');
                // å¦‚æœæ˜¯é è¦½ç’°å¢ƒï¼Œè‡ªå‹•å¹«ä½¿ç”¨è€…å¡«å…¥ Config
                if(envConfig) {
                    localStorage.setItem('nook_firebase_config', JSON.stringify(envConfig));
                }
            }
        }

        function showAppUI() {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('main-nav').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('main-footer').classList.remove('hidden');
            document.getElementById('id-badge').innerText = `ID: ${appId}`;
            document.getElementById('footer-id').innerText = appId;
            switchView('dashboard');
        }

        // åˆå§‹åŒ– Firebase
        async function initFirebase(config) {
            if (!firebase.apps.length) {
                firebase.initializeApp(config);
            }
            auth = firebase.auth();
            db = firebase.firestore();

            // åŒ¿åç™»å…¥
            await auth.signInAnonymously();
            
            // é–‹å§‹ç›£è½ (è·¯å¾‘åŒ…å« appId)
            setupListeners();
        }

        function setupListeners() {
            // 1. ç›£è½è¨˜å¸³
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('expenses')
                .orderBy('time', 'desc')
                .onSnapshot(snapshot => {
                    expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAccounting();
                    updateDashboard();
                }, err => console.error("Sync Error:", err));

            // 2. ç›£è½æ¸…å–®
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('lists')
                .orderBy('time', 'asc')
                .onSnapshot(snapshot => {
                    const all = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    packList = all.filter(i => i.type === 'pack');
                    shopList = all.filter(i => i.type === 'shop');
                    renderLists();
                });
        }

        // --- ç™»å…¥èˆ‡è¨­å®šç›¸é—œ ---
        function saveTravelId() {
            const id = document.getElementById('travel-id-input').value.trim();
            const configStored = localStorage.getItem('nook_firebase_config');
            
            if (!configStored) {
                alert('âš ï¸ è«‹å…ˆè¨­å®šä¸‹æ–¹çš„é›²ç«¯è³‡æ–™åº« (Firebase Config)ï¼');
                document.getElementById('config-panel').classList.remove('hidden');
                return;
            }
            if (!id) {
                alert('è«‹è¼¸å…¥ä»£ç¢¼ (ä¾‹å¦‚: Trip2026)');
                return;
            }
            
            localStorage.setItem('nook_travel_id', id);
            
            // æ¸…é™¤ç¶²å€åƒæ•¸ï¼Œé¿å…é‡æ•´å¾Œé‚è¼¯æ··äº‚ï¼Œä½†é€™åœ¨éœæ…‹é é¢å¯èƒ½ç„¡æ•ˆ
            // æ”¹ç‚ºç›´æ¥ reload
            location.href = window.location.pathname; 
        }

        function copyShareLink() {
            if (!appId) return;
            const url = window.location.href.split('?')[0] + '?id=' + appId;
            navigator.clipboard.writeText(url).then(() => {
                const toast = document.getElementById("toast");
                toast.className = "show";
                setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
            }).catch(err => {
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ç¶²å€ï¼š\n' + url);
            });
        }

        function toggleConfigPanel() {
            const panel = document.getElementById('config-panel');
            panel.classList.toggle('hidden');
            const existing = localStorage.getItem('nook_firebase_config');
            if(existing) document.getElementById('config-input').value = existing;
        }

        function saveConfig() {
            const raw = document.getElementById('config-input').value.trim();
            try {
                let cleanRaw = raw;
                if(raw.includes('=')) cleanRaw = raw.split('=')[1].trim();
                if(cleanRaw.endsWith(';')) cleanRaw = cleanRaw.slice(0, -1);
                
                JSON.parse(cleanRaw); // é©—è­‰ JSON
                localStorage.setItem('nook_firebase_config', cleanRaw);
                alert('âœ… è¨­å®šå·²å„²å­˜ï¼è«‹è¼¸å…¥ä»£ç¢¼é–‹å§‹ä½¿ç”¨ã€‚');
                document.getElementById('config-panel').classList.add('hidden');
            } catch(e) {
                alert('âŒ æ ¼å¼éŒ¯èª¤ï¼è«‹ç¢ºä¿è¤‡è£½çš„æ˜¯å®Œæ•´çš„ { ... } å…§å®¹ã€‚');
            }
        }

        function logout() {
            if(confirm('è¦ç™»å‡ºä¸¦æ›´æ›ä»£ç¢¼å—ï¼Ÿ')) {
                localStorage.removeItem('nook_travel_id');
                window.location.href = window.location.pathname; // å›é¦–é ä¸å¸¶åƒæ•¸
            }
        }

        // --- åŠŸèƒ½é‚è¼¯ ---
        
        // è¨˜å¸³
        async function addExpense() {
            const cat = document.getElementById('acc-cat').value;
            const item = document.getElementById('acc-item').value;
            const amt = parseFloat(document.getElementById('acc-amt').value);
            const curr = document.getElementById('acc-curr').value;
            if(!item || !amt) return;

            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('expenses').add({
                time: Date.now(), cat, item, amt, curr
            });
            
            document.getElementById('acc-item').value = '';
            document.getElementById('acc-amt').value = '';
            // alert('è¨˜å¸³æˆåŠŸï¼'); // ç§»é™¤ alert é«”é©—æ›´å¥½
        }

        async function delExpense(id) {
            if(confirm('ç¢ºå®šåˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ')) {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('expenses').doc(id).delete();
            }
        }

        function renderAccounting() {
            const list = document.getElementById('expense-list');
            list.innerHTML = '';
            if(expenses.length === 0) {
                list.innerHTML = `<div class="text-center text-gray-400 py-10">é€™è£¡é‚„ç©ºç©ºçš„ï¼Œé–‹å§‹è¨˜å¸³å§ï¼</div>`;
                return;
            }
            
            expenses.forEach(ex => {
                const twd = ex.curr === 'JPY' ? Math.round(ex.amt * RATE) : ex.amt;
                const idParam = `'${ex.id}'`;
                list.innerHTML += `
                    <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition">
                        <div class="flex items-center">
                            <span class="w-10 h-10 rounded-full bg-[#F1F8E9] text-xl flex items-center justify-center mr-3 select-none">${ex.cat.substring(0,2)}</span>
                            <div>
                                <div class="font-bold text-[#594A3D]">${ex.item}</div>
                                <div class="text-xs text-gray-400">${ex.amt} ${ex.curr}</div>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <span class="font-bold text-[#E65100] mr-4">$${twd}</span>
                            <button onclick="delExpense(${idParam})" class="text-gray-300 hover:text-red-500 font-bold px-2">Ã—</button>
                        </div>
                    </div>`;
            });
        }

        // æ¸…å–®
        async function addListItem() {
            const val = document.getElementById('list-input').value;
            if(!val) return;
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('lists').add({
                time: Date.now(), text: val, type: listMode, checked: false
            });
            document.getElementById('list-input').value = '';
        }

        async function delListItem(id) {
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('lists').doc(id).delete();
        }

        function renderLists() {
            const container = document.getElementById('list-container');
            const btnPack = document.getElementById('btn-pack');
            const btnShop = document.getElementById('btn-shop');
            
            // Toggle Button Styles
            if(listMode === 'pack') {
                btnPack.className = "flex-1 py-2 rounded-lg font-bold transition bg-[#FFF3E0] text-[#E65100]";
                btnShop.className = "flex-1 py-2 rounded-lg font-bold transition text-gray-500 hover:bg-gray-50";
            } else {
                btnShop.className = "flex-1 py-2 rounded-lg font-bold transition bg-[#E0F2F1] text-[#00695C]";
                btnPack.className = "flex-1 py-2 rounded-lg font-bold transition text-gray-500 hover:bg-gray-50";
            }

            container.innerHTML = '';
            const currentList = listMode === 'pack' ? packList : shopList;
            if(currentList.length === 0) {
                container.innerHTML = `<div class="col-span-1 md:col-span-2 text-center text-gray-400 py-6">æ¸…å–®æ˜¯ç©ºçš„</div>`;
                return;
            }
            
            currentList.forEach(item => {
                const idParam = `'${item.id}'`;
                container.innerHTML += `
                    <div class="flex items-center justify-between bg-white p-4 rounded-xl border border-gray-100 hover:shadow-md transition">
                        <span class="font-bold text-gray-700 ml-2">${item.text}</span>
                        <button onclick="delListItem(${idParam})" class="text-gray-300 hover:text-red-500 font-bold px-2">Ã—</button>
                    </div>`;
            });
        }

        // ç¸½è¦½æ›´æ–°
        function updateDashboard() {
            let varTotal = 0;
            expenses.forEach(e => { varTotal += (e.curr === 'JPY' ? Math.round(e.amt * RATE) : parseFloat(e.amt)); });
            document.getElementById('variable-spent').innerText = new Intl.NumberFormat().format(varTotal);
            document.getElementById('total-spent').innerText = new Intl.NumberFormat().format(FIXED_COST + varTotal);
            
            const total = FIXED_COST + varTotal;
            // é¿å…é™¤ä»¥é›¶
            if(total > 0) {
                const varPercent = Math.min((varTotal / total) * 100, 100);
                document.getElementById('variable-bar').style.width = varPercent + '%';
            }
        }

        // é é¢åˆ‡æ›
        function switchView(viewId) {
            document.querySelectorAll('main > section').forEach(el => { el.classList.add('hidden'); el.classList.remove('fade-in'); });
            const target = document.getElementById(`view-${viewId}`);
            if(target) { target.classList.remove('hidden'); void target.offsetWidth; target.classList.add('fade-in'); window.scrollTo(0,0); }
            
            // æ›´æ–°å°è¦½åˆ—ç‹€æ…‹
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            const navBtn = document.getElementById(`nav-${viewId}`);
            if(navBtn) navBtn.classList.add('active');
            
            if(viewId === 'dashboard') updateDashboard();
        }

        function closeMenu() {
            document.getElementById('mobile-menu').classList.add('hidden');
        }
    </script>
</body>
</html>
