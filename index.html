<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2026 å±±æ¢¨ç”²æ–æ—… (æœ€çµ‚å®Œç¾ç‰ˆ)</title>
    
    <script>
        window.onerror = function(msg, url, line) {
            console.error("Error: " + msg);
            return false; 
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EğŸƒ%3C/text%3E%3C/svg%3E">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        .hidden { display: none !important; }
        
        :root { 
            --ac-green: #8DD27E; 
            --ac-green-dark: #6BAF5C;
            --ac-cream: #FFFDF6; 
            --ac-brown: #796652; 
            --ac-blue: #70D3E8; 
            --ac-yellow: #F9E776; 
            --ac-orange: #FFB366;
        }
        
        body { 
            font-family: 'M PLUS Rounded 1c', sans-serif; 
            background-color: var(--ac-cream); 
            color: var(--ac-brown); 
            background-image: radial-gradient(#E9F5E6 20%, transparent 20%), radial-gradient(#E9F5E6 20%, transparent 20%);
            background-size: 30px 30px; 
            background-position: 0 0, 15px 15px;
            -webkit-tap-highlight-color: transparent; 
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .nook-card { 
            background-color: rgba(255, 255, 255, 0.95); 
            border-radius: 1.5rem; 
            box-shadow: 0 8px 20px -6px rgba(121, 102, 82, 0.1); 
            border: 2px solid #F0EAE0; 
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            backdrop-filter: blur(8px);
        }
        .nook-card:active { transform: scale(0.98); }
        
        .nook-btn { 
            border-radius: 9999px; font-weight: 800; transition: all 0.1s; cursor: pointer; user-select: none; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.15); transform: translateY(0);
        }
        .nook-btn:active { transform: translateY(4px); box-shadow: 0 0 0 rgba(0,0,0,0); }
        
        .nav-island {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-radius: 2rem;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.5);
            margin: 0 1rem 1rem 1rem;
        }
        
        .nav-item { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            color: #C0B2A6; font-size: 0.65rem; font-weight: bold; transition: all 0.3s; 
            position: relative;
        }
        .nav-item.active { color: var(--ac-green-dark); transform: translateY(-4px); }
        .nav-item.active .nav-icon { transform: scale(1.2); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 2px; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        
        .timeline-line { position: absolute; left: 1.15rem; top: 1rem; bottom: -1rem; border-left: 3px dotted #DCD0C0; z-index: 0; }
        .timeline-dot { box-shadow: 0 0 0 4px #FDFBF0; }

        /* è©³ç´°è¡Œç¨‹å°ˆç”¨æ¨£å¼ */
        .transport-card { 
            background-color: #E0F7FA; border: 2px dashed #4DD0E1; 
            border-radius: 1rem; padding: 0.75rem; margin-top: 0.75rem; 
            font-size: 0.85rem; color: #006064; position: relative; 
        }
        .transport-card::before { 
            content: "âœˆï¸ äº¤é€šç§»å‹•"; position: absolute; top: -10px; right: 10px; 
            background: #4DD0E1; color: white; font-size: 0.6rem; 
            padding: 2px 6px; border-radius: 4px; font-weight: bold; 
        }

        .modal { position: fixed; inset: 0; background: rgba(121, 102, 82, 0.4); z-index: 1000; display: flex; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(4px); }
        .modal-content { 
            background: #FFFDF6; border-radius: 2rem; padding: 2rem; width: 100%; max-width: 340px; 
            border: 4px solid var(--ac-yellow); 
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); 
            animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
        }
        @keyframes bounceIn { 
            0% { transform: scale(0.8); opacity: 0; } 
            100% { transform: scale(1); opacity: 1; } 
        }

        .cute-input {
            width: 100%; border: 2px solid #EEE8D6; background: #FFF;
            border-radius: 1rem; padding: 0.8rem; outline: none;
            transition: border-color 0.2s; color: var(--ac-brown); font-weight: bold;
        }
        .cute-input:focus { border-color: var(--ac-yellow); }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden text-[#796652]">

    <!-- Login Modal -->
    <div id="login-modal" class="modal hidden">
        <div class="modal-content text-center relative overflow-hidden">
            <div class="absolute top-[-20px] left-[-20px] w-20 h-20 bg-[#F9E776] rounded-full opacity-20"></div>
            <div class="absolute bottom-[-20px] right-[-20px] w-24 h-24 bg-[#8DD27E] rounded-full opacity-20"></div>
            
            <div class="relative z-10">
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-[#8DD27E] shadow-sm text-3xl">ğŸƒ</div>
                <h2 class="text-2xl font-black text-[#6B5643] mb-1">é–‹å§‹æ—…ç¨‹</h2>
                <p class="text-sm text-[#A69585] mb-6 font-bold">åŒæ­¥æ‚¨çš„ 2026 å±±æ¢¨ä¹‹æ—…</p>
                
                <input type="text" id="travel-id-input" placeholder="è¼¸å…¥æ—…è²»ä»£ç¢¼ (ä¾‹: Trip2026)" class="cute-input text-center text-lg mb-4 uppercase tracking-widest placeholder:tracking-normal">
                
                <button onclick="saveTravelId(this)" class="w-full bg-[#8DD27E] text-white py-3 text-lg nook-btn mb-6">ğŸš€ å‡ºç™¼ï¼</button>
                
                <div class="border-t border-[#EEE8D6] pt-4">
                    <button onclick="toggleConfigPanel()" class="text-xs text-[#A69585] font-bold hover:text-[#8DD27E] transition">ğŸ› ï¸ è¨­å®šé›²ç«¯è³‡æ–™åº« (åˆæ¬¡å¿…é»)</button>
                    <div class="mt-2"><button onclick="resetAll()" class="text-[10px] text-red-300 hover:text-red-500">é‡ç½® App</button></div>
                </div>
            </div>
            
            <div id="config-panel" class="hidden mt-4 text-left bg-white p-3 rounded-xl border-2 border-[#EEE8D6] relative z-10">
                <p class="text-xs text-gray-400 mb-2 font-bold">è²¼ä¸Š Firebase Config:</p>
                <textarea id="config-input" class="w-full h-20 text-[10px] p-2 rounded-lg bg-[#FAFAFA] border border-gray-200 resize-none outline-none focus:border-[#F9E776]" placeholder="{ apiKey: ... }"></textarea>
                <button onclick="saveConfig(this)" class="w-full mt-2 bg-[#F9E776] text-[#796652] font-bold py-2 rounded-lg text-xs nook-btn">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md h-16 flex items-center justify-between px-5 z-10 flex-none sticky top-0 border-b border-white/50">
        <div class="font-black text-xl tracking-wider flex items-center text-[#6B5643]">
            <span class="mr-2 text-2xl">ğŸƒ</span> 2026 å±±æ¢¨
        </div>
        <button onclick="copyShareLink()" class="bg-[#F0EAE0] px-3 py-1.5 rounded-full text-xs font-bold text-[#796652] hover:bg-[#E0D8CC] transition flex items-center">
            <span id="header-id" class="mr-1">ID: --</span> ğŸ“‹
        </button>
    </header>

    <!-- Main Content -->
    <main id="main-container" class="flex-grow overflow-y-auto p-5 pb-32 space-y-6 hidden custom-scroll">
        
        <!-- Dashboard -->
        <section id="view-dashboard" class="fade-in space-y-5">
            <div class="nook-card p-6 border-t-[6px] border-[#F9E776] relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl">ğŸ’°</div>
                <div class="flex justify-between items-end mb-3 relative z-10">
                    <div>
                        <h2 class="text-sm font-bold text-[#A69585]">ç¸½æ”¯å‡º (TWD)</h2>
                        <span class="text-3xl font-black text-[#FFB366]" id="total-spent">--</span>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-bold bg-[#E9F5E6] text-[#6BAF5C] px-2 py-1 rounded-lg mb-1">é ç®—ç›£æ§ä¸­</div>
                    </div>
                </div>
                <div class="h-4 bg-[#F0EAE0] rounded-full overflow-hidden flex mb-3 shadow-inner">
                    <div class="bg-[#8DD27E] w-1/2 h-full rounded-r-sm" title="å›ºå®šæ”¯å‡º"></div>
                    <div class="bg-[#FFB366] w-0 h-full transition-all duration-1000 ease-out rounded-r-full" id="variable-bar" title="æµ®å‹•æ”¯å‡º"></div>
                </div>
                <div class="flex justify-between text-xs font-bold text-[#A69585]">
                    <span>âœˆï¸ å›ºå®š: 36,046</span>
                    <span class="text-[#FFB366]">ğŸ”¥ æµ®å‹•: <span id="variable-spent">0</span></span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div onclick="switchView('accounting')" class="nook-card p-4 flex flex-col items-center justify-center bg-white cursor-pointer active:scale-95 transition-transform h-28 border-b-[4px] border-[#EEE8D6]">
                    <span class="text-3xl mb-2">ğŸ“</span><span class="font-black text-[#796652]">è¨˜ä¸€ç­†</span>
                </div>
                <div onclick="switchView('lists')" class="nook-card p-4 flex flex-col items-center justify-center bg-white cursor-pointer active:scale-95 transition-transform h-28 border-b-[4px] border-[#EEE8D6]">
                    <span class="text-3xl mb-2">ğŸ’</span><span class="font-black text-[#009688]">æ¸…å–®</span>
                </div>
            </div>

            <div class="nook-card p-5 border-l-[6px] border-[#70D3E8] flex items-center justify-between cursor-pointer" onclick="switchView('transport')">
                <div>
                    <h3 class="font-bold text-[#00838F] text-xs mb-1 uppercase tracking-wide">Next Highlight</h3>
                    <div class="text-lg font-black text-[#6B5643]">Day 3 å·´å£«ç§»å‹•</div>
                    <p class="text-xs text-[#A69585] mt-1">10:08 çŸ³å’Œæº«æ³‰ â†’ æ²³å£æ¹–</p>
                </div>
                <div class="text-3xl">ğŸšŒ</div>
            </div>
        </section>

        <!-- Itinerary (è©³ç´°å…§å®¹å›æ­¸ç‰ˆ) -->
        <section id="view-itinerary" class="hidden fade-in">
            <div class="flex overflow-x-auto space-x-3 pb-2 mb-4 no-scrollbar px-1">
                <button onclick="renderDay(1)" class="px-5 py-2.5 bg-white rounded-2xl text-sm font-bold text-[#A69585] shadow-sm border border-transparent whitespace-nowrap transition-all day-tab" id="tab-day1">3/13(äº”)</button>
                <button onclick="renderDay(2)" class="px-5 py-2.5 bg-white rounded-2xl text-sm font-bold text-[#A69585] shadow-sm border border-transparent whitespace-nowrap transition-all day-tab" id="tab-day2">3/14(å…­)</button>
                <button onclick="renderDay(3)" class="px-5 py-2.5 bg-white rounded-2xl text-sm font-bold text-[#A69585] shadow-sm border border-transparent whitespace-nowrap transition-all day-tab" id="tab-day3">3/15(æ—¥)</button>
                <button onclick="renderDay(4)" class="px-5 py-2.5 bg-white rounded-2xl text-sm font-bold text-[#A69585] shadow-sm border border-transparent whitespace-nowrap transition-all day-tab" id="tab-day4">3/16(ä¸€)</button>
                <button onclick="renderDay(5)" class="px-5 py-2.5 bg-white rounded-2xl text-sm font-bold text-[#A69585] shadow-sm border border-transparent whitespace-nowrap transition-all day-tab" id="tab-day5">3/17(äºŒ)</button>
            </div>
            <div id="day-content" class="space-y-6 px-1"></div>
        </section>

        <!-- Accounting -->
        <section id="view-accounting" class="hidden fade-in space-y-5">
            <div class="nook-card p-5 bg-white sticky top-0 z-10 shadow-lg border-2 border-[#8DD27E]">
                <div class="grid grid-cols-4 gap-3 mb-3">
                    <select id="acc-cat" class="col-span-1 bg-[#E9F5E6] rounded-xl text-sm font-bold text-[#6BAF5C] text-center outline-none h-12">
                        <option value="é¤é£²">é¤é£²</option><option value="äº¤é€š">äº¤é€š</option><option value="é–€ç¥¨">é–€ç¥¨</option><option value="è³¼ç‰©">è³¼ç‰©</option><option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                    <input type="text" id="acc-item" placeholder="é …ç›®åç¨±" class="col-span-3 bg-[#FAFAFA] border-2 border-[#EEE8D6] rounded-xl px-3 text-sm outline-none font-bold focus:border-[#8DD27E] h-12">
                </div>
                <div class="flex gap-3 mb-4">
                    <input type="number" id="acc-amt" placeholder="0" class="flex-grow bg-[#FAFAFA] border-2 border-[#EEE8D6] rounded-xl px-3 text-lg outline-none font-black focus:border-[#8DD27E] h-12" inputmode="decimal">
                    <select id="acc-curr" class="bg-[#FFF9C4] rounded-xl text-sm px-3 font-bold text-[#E65100] outline-none h-12 border-2 border-[#F9E776]"><option value="JPY">Â¥ JPY</option><option value="TWD">$ TWD</option></select>
                </div>
                <button onclick="addExpense()" class="w-full bg-[#8DD27E] text-white font-black py-3.5 rounded-xl text-lg nook-btn shadow-md active:bg-[#6BAF5C]">ï¼‹ æ–°å¢ç´€éŒ„</button>
            </div>
            <div id="expense-list" class="space-y-3 pb-10"></div>
        </section>

        <!-- Lists -->
        <section id="view-lists" class="hidden fade-in space-y-5">
            <div class="flex gap-3 mb-2 bg-white/50 p-1.5 rounded-2xl">
                <button onclick="listMode='pack'; renderLists()" class="flex-1 py-3 rounded-xl font-bold transition text-sm tracking-wide shadow-sm" id="btn-pack">ğŸ’ å‡ºç™¼å¿…å¸¶</button>
                <button onclick="listMode='shop'; renderLists()" class="flex-1 py-3 rounded-xl font-bold transition text-sm tracking-wide" id="btn-shop">ğŸ›ï¸ è³¼ç‰©é¡˜æœ›</button>
            </div>
            <div class="flex gap-3">
                <input type="text" id="list-input" class="flex-grow p-3 rounded-xl border-2 border-[#EEE8D6] outline-none font-bold focus:border-[#70D3E8]" placeholder="æ–°å¢é …ç›®...">
                <button onclick="addListItem()" class="bg-[#70D3E8] text-white w-12 rounded-xl font-bold text-xl nook-btn shadow-md">+</button>
            </div>
            <div id="list-container" class="space-y-3 pb-10"></div>
        </section>

        <!-- Info -->
        <section id="view-info" class="hidden fade-in space-y-5">
            <div class="nook-card p-5 border-l-[6px] border-[#70D3E8]">
                <h3 class="font-bold text-[#00838F] mb-3 text-lg">ğŸšŒ æ²³å£æ¹–å‘¨éŠå·´å£«</h3>
                <div class="space-y-3">
                    <div class="flex items-start bg-[#E0F7FA] p-3 rounded-xl">
                        <div class="w-4 h-4 rounded-full bg-red-500 mt-1 mr-3 shrink-0 border-2 border-white shadow-sm"></div>
                        <div><div class="font-black text-sm text-[#006064]">ç´…ç·š (Red Line)</div><div class="text-xs text-[#00838F] mt-1">æ¯15åˆ†ä¸€ç­ã€‚å‰å¾€ï¼šå¤©ä¸Šå±±çºœè»Šã€ç¾è¡“é¤¨ã€HOTORIé£¯åº—ã€‚</div></div>
                    </div>
                    <div class="flex items-start bg-[#E8F5E9] p-3 rounded-xl">
                        <div class="w-4 h-4 rounded-full bg-green-500 mt-1 mr-3 shrink-0 border-2 border-white shadow-sm"></div>
                        <div><div class="font-black text-sm text-[#2E7D32]">ç¶ ç·š (Green Line)</div><div class="text-xs text-[#388E3C] mt-1">å‰å¾€ï¼šè¥¿æ¹–ç™‚ç™’ä¹‹é‡Œæ ¹å ´ã€‚</div></div>
                    </div>
                </div>
            </div>
            <div class="nook-card p-5 border-l-[6px] border-[#F9E776]">
                <h3 class="font-bold text-[#796652] mb-3 text-lg">ğŸ¡ ä½å®¿è³‡è¨Š</h3>
                <div class="space-y-4">
                    <div class="relative pl-4 border-l-2 border-[#EEE8D6]">
                        <div class="font-black text-[#6B5643]">ãƒ•ã‚¯ãƒ­ã‚¦ã®å¾¡å®¿ (å‰2æ™š)</div>
                        <div class="text-xs text-[#A69585] mt-1">çŸ³å’Œæº«æ³‰ç«™å—å£ï¼Œæ­è¨ˆç¨‹è»Šç´„10åˆ†é˜ã€‚</div>
                    </div>
                    <div class="relative pl-4 border-l-2 border-[#EEE8D6]">
                        <div class="font-black text-[#6B5643]">HOTORI no HOTEL (å¾Œ2æ™š)</div>
                        <div class="text-xs text-[#A69585] mt-1">ç´…ç·šå·´å£«ã€ŒéŸ³æ¨‚ç›’ä¹‹æ£®ç¾è¡“é¤¨ã€ç«™æ—ã€‚</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Floating Nav Island -->
    <nav class="nav-island absolute bottom-4 left-4 right-4 h-16 flex justify-around items-center z-50">
        <button onclick="switchView('dashboard')" class="nav-item text-[#8DD27E]" id="nav-dashboard"><span class="nav-icon">ğŸ“Š</span>ç¸½è¦½</button>
        <button onclick="switchView('itinerary')" class="nav-item text-[#C0B2A6]" id="nav-itinerary"><span class="nav-icon">ğŸ“…</span>è¡Œç¨‹</button>
        <button onclick="switchView('accounting')" class="nav-item text-[#C0B2A6]" id="nav-accounting"><span class="nav-icon">ğŸ’°</span>è¨˜å¸³</button>
        <button onclick="switchView('lists')" class="nav-item text-[#C0B2A6]" id="nav-lists"><span class="nav-icon">ğŸ“</span>æ¸…å–®</button>
        <button onclick="switchView('info')" class="nav-item text-[#C0B2A6]" id="nav-info"><span class="nav-icon">ğŸ’¡</span>è³‡è¨Š</button>
    </nav>

    <script>
        const FIXED_COST = 36046;
        const RATE = 0.215;
        let db, auth, appId;
        let expenses = [], packList = [], shopList = [], listMode = 'pack';

        // --- è©³ç´°è¡Œç¨‹è³‡æ–™ (å·²æ¢å¾©) ---
        const itineraryData = {
            1: { title: "3/13 (äº”) Day 1: æŠµé”èˆ‡æº«æ³‰", timeline: [ { time: "10:35", icon: "ğŸ›¬", title: "æŠµé”æˆç”° (NRT)", desc: "IT200 æŠµé”ã€‚é ˜è¡Œæã€éæµ·é—œã€‚", cost: "ç„¡", mapQuery: "Narita International Airport", transport: { mode: "N'EX", route: "æˆç”° -> æ–°å®¿", duration: "80åˆ†", note: "å»ºè­° 11:44 æˆ– 12:20" } }, { time: "11:44", icon: "ğŸš†", title: "N'EX å‰å¾€æ–°å®¿", desc: "æ­ä¹˜ N'EX æˆç”°ç‰¹å¿«ã€‚", cost: "Â¥3,270", mapQuery: "Shinjuku Station", transport: { mode: "ç‰¹æ€¥", route: "æ–°å®¿è½‰ä¹˜ Kaiji", duration: "è½‰ä¹˜æ™‚é–“ç´„ 20åˆ†", note: "9/10 æœˆå°" } }, { time: "13:30", icon: "ğŸš„", title: "è½‰ä¹˜ Kaiji ç‰¹æ€¥", desc: "æ–°å®¿è½‰ä¹˜ JR Kaiji è™Ÿå¾€çŸ³å’Œæº«æ³‰ã€‚", cost: "Â¥3,890", mapQuery: "Isawa-Onsen Station", transport: { mode: "Kaiji", route: "æ–°å®¿ -> çŸ³å’Œæº«æ³‰", duration: "90åˆ†", note: "ç›´é”" } }, { time: "15:00", icon: "ğŸš•", title: "å‰å¾€æ°‘å®¿", desc: "çŸ³å’Œæº«æ³‰ç«™æ­è¨ˆç¨‹è»Šè‡³å¤æ°‘å®¶ã€‚", cost: "ç´„ Â¥1,500", mapQuery: "ãƒ•ã‚¯ãƒ­ã‚¦ã®å¾¡å®¿ æ˜¥æ—¥å±…é¤¨", transport: { mode: "Taxi", route: "è»Šç«™ -> æ°‘å®¿", duration: "10åˆ†", note: "å—å£æ’ç­è¨ˆç¨‹è»Š" } }, { time: "18:00", icon: "ğŸ±", title: "æ™šé¤", desc: "äº«ç”¨åœ¨è»Šç«™è²·çš„ä¾¿ç•¶æˆ–é™„è¿‘çš„é¤å»³ã€‚", cost: "ç´„ Â¥1,500/äºº" } ] },
            2: { title: "3/14 (å…­) Day 2: è‰è“èˆ‡æºªè°·", timeline: [ { time: "09:00", icon: "ğŸ¯", title: "æƒ æ—å¯ºåƒæ‹œ", desc: "æ­¦ç”°ä¿¡ç„é•·çœ ä¹‹åœ°ï¼Œåº­åœ’æ¥µç¾ã€‚", hours: "8:30 - 16:30", cost: "é–€ç¥¨ Â¥300", mapQuery: "Erinji Temple", transport: { mode: "Taxi", route: "æ°‘å®¿ -> æƒ æ—å¯º", duration: "20åˆ†", note: "è«‹æ°‘å®¿å¹«å¿™å«è»Š" } }, { time: "11:00", icon: "ğŸ“", title: "Gourmet è‹ºå‰ç”°", desc: "é«˜ç´šè‰è“åƒåˆ°é£½ (30åˆ†)ã€‚", hours: "10:00 - 16:00 (éœ€é ç´„)", cost: "Â¥2,500/äºº", mapQuery: "Gourmet Strawberry Museum Maeda", transport: { mode: "Taxi", route: "æƒ æ—å¯º -> è‰è“åœ’", duration: "30åˆ†", note: "è»Šè³‡ç´„ Â¥4000 (è¼ƒè²´ä½†çœæ™‚)" } }, { time: "13:30", icon: "ğŸï¸", title: "æ˜‡ä»™å³½", desc: "æ­å·´å£«å‰å¾€ï¼Œæ¬£è³çµ•ç¾æºªè°·ã€‚", hours: "å…¨å¤©é–‹æ”¾", cost: "ä¾†å› Â¥1,200", mapQuery: "Shosenkyo", transport: { mode: "å·´å£«", route: "ç”²åºœç«™(å—å£4è™Ÿ) -> æ˜‡ä»™å³½å£", duration: "30åˆ†", note: "å±±æ¢¨äº¤é€šå·´å£«" } }, { time: "18:30", icon: "ğŸ·", title: "ç”²åºœæ™šé¤", desc: "ç”²å·å¯Œå£«æ«»è±¬ç‚¸è±¬æ’ã€‚", hours: "17:00 - 21:00", cost: "ç´„ Â¥2,000/äºº", mapQuery: "Kofu Station", transport: { mode: "JR", route: "ç”²åºœ -> çŸ³å’Œæº«æ³‰", duration: "10åˆ†", note: "å›ç¨‹" } } ] },
            3: { title: "3/15 (æ—¥) Day 3: ç§»å‹•è‡³æ²³å£æ¹–", timeline: [ { time: "10:08", icon: "ğŸšŒ", title: "ç›´é”å·´å£«", desc: "çŸ³å’Œæº«æ³‰ç™¼è»Šï¼Œå‰å¾€æ²³å£æ¹–ç«™ã€‚", cost: "Â¥1,400/äºº", mapQuery: "Isawa-Onsen Station", transport: { mode: "å¯Œå£«æ€¥å·´å£«", route: "çŸ³å’Œæº«æ³‰ -> æ²³å£æ¹–ç«™", duration: "50åˆ†", note: "å¿…æ­ 10:08 ç­æ¬¡!" } }, { time: "12:00", icon: "ğŸ˜ï¸", title: "è¥¿æ¹–ç™‚ç™’ä¹‹é‡Œæ ¹å ´", desc: "åƒè§€èŒ…è‰å±‹èšè½ã€åƒåˆé¤ã€‚", hours: "9:00 - 17:00", cost: "é–€ç¥¨ Â¥500", mapQuery: "Saiko Iyashi-no-Sato Nenba", transport: { mode: "ç¶ ç·šå·´å£«", route: "æ²³å£æ¹–ç«™ -> è¥¿æ¹–æ ¹å ´", duration: "40åˆ†", note: "1è™Ÿä¹˜è»Šè™•" } }, { time: "15:00", icon: "ğŸŒ¸", title: "å¤§çŸ³å…¬åœ’", desc: "ç´…ç·šå·´å£«çµ‚é»ï¼Œå…è²»å…¥åœ’ã€‚", hours: "å…¨å¤©é–‹æ”¾ (å•†åº—~17:00)", cost: "å…è²»", mapQuery: "Oishi Park", transport: { mode: "è½‰ä¹˜", route: "ç¶ ç·šå›è»Šç«™ -> ç´…ç·šå»å¤§çŸ³", duration: "60åˆ†", note: "éœ€å›æ²³å£æ¹–ç«™è½‰è»Š" } }, { time: "16:30", icon: "ğŸ¨", title: "Check-in", desc: "å…¥ä½ HOTORI Hotelã€‚", cost: "å·²ä»˜", mapQuery: "HOTORI no HOTEL BAN", transport: { mode: "ç´…ç·šå·´å£«", route: "å¤§çŸ³å…¬åœ’ -> éŸ³æ¨‚ç›’ä¹‹æ£®", duration: "10åˆ†", note: "é£¯åº—åœ¨ç«™ç‰Œæ—" } } ] },
            4: { title: "3/16 (ä¸€) Day 4: å¤©ç©ºé³¥å±…èˆ‡çºœè»Š", timeline: [ { time: "09:00", icon: "â›©ï¸", title: "æ²³å£æ·ºé–“ç¥ç¤¾ (å¤©ç©ºé³¥å±…)", desc: "æ—©èµ·å‰å¾€é™æ‹œæ‰€ã€‚æ‹æ”å·¨å¤§é³¥å±…èˆ‡å¯Œå£«å±±çš„å¤¢å¹»åˆå½±ã€‚", hours: "9:00 - 16:00", cost: "å”åŠ›é‡‘ Â¥100", mapQuery: "Tenku no Torii", transport: { mode: "Taxi", route: "é£¯åº— -> é™æ‹œæ‰€", duration: "ç´„15åˆ†", note: "å»ºè­°ç›´æ¥å«è»Šä¸Šå±±" } }, { time: "11:30", icon: "ğŸœ", title: "Hoto Fudo (åŒ—æœ¬åº—)", desc: "ä¸‹å±±å¾Œï¼Œå‰å¾€é€™é–“è‘—åçš„é¤ºé£¥éºµé¤å»³äº«ç”¨åˆé¤ã€‚", hours: "11:00 - 20:00", cost: "Â¥1,210", mapQuery: "Hoto Fudo Kawaguchiko North Main Shop", transport: { mode: "Taxi/Walk", route: "é™æ‹œæ‰€ -> é¤å»³", duration: "10-15åˆ†", note: "è¨ˆç¨‹è»Šä¸‹å±±æœ€æ–¹ä¾¿" } }, { time: "14:00", icon: "ğŸš ", title: "æ²³å£æ¹–çºœè»Š", desc: "æ­ä¹˜çºœè»Šè‡³å¤©ä¸Šå±±å…¬åœ’ï¼Œä¿¯ç°æ²³å£æ¹–å…¨æ™¯ã€‚å¯ä»¥åƒçƒ¤ç³°å­ã€‚", hours: "9:30 - 16:00 (å¹³æ—¥)", cost: "ä¾†å› Â¥900", mapQuery: "Mt. Fuji Panoramic Ropeway", transport: { mode: "ç´…ç·šå·´å£«", route: "éŸ³æ¨‚ç›’ä¹‹æ£® -> éŠè¦½èˆ¹/çºœè»Šå£", duration: "ç´„15åˆ†", note: "é£¯åº—æ—æ­è»Š" } }, { time: "16:00", icon: "ğŸ¨", title: "ä¹…ä¿ç”°ä¸€ç«¹ç¾è¡“é¤¨", desc: "åƒè§€å’Œæœè—è¡“ (12-3æœˆé€±äºŒä¼‘é¤¨ï¼Œä»Šæ—¥é€±ä¸€æœ‰é–‹!)", hours: "10:00 - 16:30", cost: "Â¥1,300", mapQuery: "Itchiku Kubota Art Museum", transport: { mode: "ç´…ç·šå·´å£«", route: "çºœè»Š -> ç¾è¡“é¤¨", duration: "15åˆ†", note: "æ³¨æ„æœ€å¾Œå…¥é¤¨æ™‚é–“" } } ] },
            5: { title: "3/17 (äºŒ) Day 5: è¿”ç¨‹", timeline: [ { time: "11:00", icon: "ğŸ‘‹", title: "é€€æˆ¿ & å·´å£«", desc: "æ­ç´…ç·šå·´å£«å›æ²³å£æ¹–ç«™ã€‚", cost: "ç´„ Â¥400", mapQuery: "Kawaguchiko Station", transport: { mode: "ç´…ç·šå·´å£«", route: "é£¯åº— -> æ²³å£æ¹–ç«™", duration: "20åˆ†", note: "é ç•™æ™‚é–“é€›è»Šç«™" } }, { time: "13:00", icon: "ğŸš†", title: "å¯Œå£«å›éŠ", desc: "ç‰¹æ€¥ç›´é”æ–°å®¿ã€‚é€±äºŒç„¡åŠ ç­è»Šã€‚", cost: "Â¥4,130", mapQuery: "Shinjuku Station", transport: { mode: "å¯Œå£«å›éŠ", route: "æ²³å£æ¹– -> æ–°å®¿", duration: "2hr", note: "é ç´„ 12:04 (å›éŠ16) æˆ– 14:04 (å›éŠ20)" } }, { time: "17:00", icon: "ğŸ›«", title: "N'EX å¾€æ©Ÿå ´", desc: "æ–°å®¿è½‰ä¹˜ N'EXã€‚", cost: "Â¥3,270", mapQuery: "Narita International Airport", transport: { mode: "N'EX", route: "æ–°å®¿ -> æˆç”°", duration: "80åˆ†", note: "18:25 å‰æŠµé”æ«ƒæª¯" } }, { time: "20:25", icon: "âœˆï¸", title: "èµ·é£›è¿”å°", desc: "IT203 é£›å¾€ TPEã€‚", cost: "å·²ä»˜", mapQuery: "Narita International Airport", transport: { mode: "é£›è¡Œæ©Ÿ", route: "NRT -> TPE", duration: "4hr", note: "å†è¦‹äº†æ—¥æœ¬!" } } ] }
        };

        const categoryIcons = {
            "é¤é£²": "ğŸ±",
            "äº¤é€š": "ğŸš†",
            "é–€ç¥¨": "ğŸŸï¸",
            "è³¼ç‰©": "ğŸ›ï¸",
            "å…¶ä»–": "â“"
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const urlId = new URLSearchParams(window.location.search).get('id');
            if(urlId) document.getElementById('travel-id-input').value = urlId;
            try { await checkLogin(urlId); } catch(e) { console.error(e); document.getElementById('login-modal').classList.remove('hidden'); }
        });

        async function checkLogin(urlId) {
            const savedId = localStorage.getItem('nook_travel_id');
            const savedConfig = localStorage.getItem('nook_firebase_config');
            const targetId = urlId || savedId;
            
            if (targetId && savedConfig) {
                appId = targetId;
                localStorage.setItem('nook_travel_id', appId);
                document.getElementById('header-id').innerText = `ID: ${appId}`;
                await initFirebase(JSON.parse(savedConfig));
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('main-container').classList.remove('hidden');
                switchView('dashboard');
                renderDay(1); // é è¼‰ Day 1
            } else {
                document.getElementById('login-modal').classList.remove('hidden');
            }
        }

        async function initFirebase(config) {
            if (!firebase.apps.length) firebase.initializeApp(config);
            auth = firebase.auth();
            db = firebase.firestore();
            await auth.signInAnonymously();
            setupListeners();
        }

        function setupListeners() {
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('expenses').orderBy('time', 'desc')
                .onSnapshot(snap => { expenses = snap.docs.map(doc => ({id: doc.id, ...doc.data()})); renderAccounting(); updateDashboard(); });
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('lists').orderBy('time', 'asc')
                .onSnapshot(snap => { const all = snap.docs.map(doc => ({id: doc.id, ...doc.data()})); packList = all.filter(i => i.type === 'pack'); shopList = all.filter(i => i.type === 'shop'); renderLists(); });
        }

        function saveTravelId(btn) {
            const id = document.getElementById('travel-id-input').value.trim();
            if(!localStorage.getItem('nook_firebase_config')) return alert('è«‹å…ˆè¨­å®šé›²ç«¯è³‡æ–™åº«ï¼');
            if(!id) return alert('è«‹è¼¸å…¥ä»£ç¢¼');
            btn.innerText = "ğŸƒ è¼‰å…¥ä¸­...";
            localStorage.setItem('nook_travel_id', id);
            location.href = window.location.pathname;
        }

        function saveConfig(btn) {
            let raw = document.getElementById('config-input').value.trim();
            btn.innerText = "è™•ç†ä¸­...";
            try {
                raw = raw.replace(/\/\/.*$/gm, '').replace(/[\u2018\u2019]/g, "'").replace(/[\u201C\u201D]/g, '"');
                if(raw.includes('=')) raw = raw.substring(raw.indexOf('=') + 1).trim();
                if(raw.endsWith(';')) raw = raw.slice(0, -1).trim();
                let jsonStr = raw.replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:/g, '"$2":').replace(/,(\s*})/g, '$1');
                if(!jsonStr.startsWith('{')) jsonStr = '{' + jsonStr + '}';
                const config = JSON.parse(jsonStr);
                if(!config.apiKey) throw new Error("ç„¡æ•ˆçš„ Config");
                localStorage.setItem('nook_firebase_config', JSON.stringify(config));
                alert('âœ… è¨­å®šå®Œæˆï¼');
                location.reload();
            } catch(e) {
                btn.innerText = "å„²å­˜è¨­å®š";
                alert('æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªè¤‡è£½å…§å®¹ã€‚');
            }
        }

        function resetAll() { if(confirm('ç¢ºå®šé‡ç½® Appï¼Ÿ')) { localStorage.removeItem('nook_travel_id'); localStorage.removeItem('nook_firebase_config'); location.reload(); } }
        function copyShareLink() { const url = window.location.href.split('?')[0] + '?id=' + appId; navigator.clipboard.writeText(url).then(() => alert('ğŸ“‹ ç¶²å€å·²è¤‡è£½ï¼å‚³çµ¦æ—…ä¼´å§ï¼')); }
        function toggleConfigPanel() { document.getElementById('config-panel').classList.toggle('hidden'); }

        function addExpense() {
            const item = document.getElementById('acc-item').value; const amt = document.getElementById('acc-amt').value;
            if(!item || !amt) return;
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('expenses').add({ time: Date.now(), cat: document.getElementById('acc-cat').value, item, amt: parseFloat(amt), curr: document.getElementById('acc-curr').value });
            document.getElementById('acc-item').value = ''; document.getElementById('acc-amt').value = '';
        }
        function delExpense(id) { db.collection('artifacts').doc(appId).collection('public').doc('data').collection('expenses').doc(id).delete(); }
        
        function addListItem() {
            const val = document.getElementById('list-input').value; if(!val) return;
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('lists').add({ time: Date.now(), text: val, type: listMode, checked: false });
            document.getElementById('list-input').value = '';
        }
        function delListItem(id) { db.collection('artifacts').doc(appId).collection('public').doc('data').collection('lists').doc(id).delete(); }

        function renderAccounting() {
            const list = document.getElementById('expense-list'); list.innerHTML = '';
            if(expenses.length === 0) return list.innerHTML = '<div class="text-center text-gray-300 py-10 text-sm font-bold">é‚„æ²’æœ‰è¨˜å¸³å–” ğŸƒ</div>';
            expenses.forEach(ex => {
                const twd = ex.curr === 'JPY' ? Math.round(ex.amt * RATE) : ex.amt;
                const icon = categoryIcons[ex.cat] || "ğŸ’°";
                list.innerHTML += `<div class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border border-[#EEE8D6] mb-1"><div class="flex items-center"><div class="w-10 h-10 rounded-full bg-[#E9F5E6] flex items-center justify-center mr-3 text-lg">${icon}</div><div><div class="font-bold text-[#6B5643]">${ex.item}</div><div class="text-xs text-[#A69585] font-bold mt-0.5">${ex.amt.toLocaleString()} ${ex.curr}</div></div></div><div class="flex items-center"><span class="font-black text-[#FFB366] mr-4">$${twd.toLocaleString()}</span><button onclick="delExpense('${ex.id}')" class="text-gray-300 hover:text-red-400 text-lg px-2">Ã—</button></div></div>`;
            });
        }

        function renderLists() {
            const list = document.getElementById('list-container'); const data = listMode === 'pack' ? packList : shopList;
            const btnPack = document.getElementById('btn-pack'); const btnShop = document.getElementById('btn-shop');
            
            if(listMode === 'pack') {
                btnPack.className = "flex-1 py-3 rounded-xl font-black transition bg-[#F9E776] text-[#796652] shadow-sm transform scale-105";
                btnShop.className = "flex-1 py-3 rounded-xl font-bold transition text-[#A69585] hover:bg-white/50";
            } else {
                btnShop.className = "flex-1 py-3 rounded-xl font-black transition bg-[#70D3E8] text-white shadow-sm transform scale-105";
                btnPack.className = "flex-1 py-3 rounded-xl font-bold transition text-[#A69585] hover:bg-white/50";
            }

            list.innerHTML = '';
            if(data.length === 0) return list.innerHTML = '<div class="text-center text-gray-300 py-10 text-sm font-bold">æ¸…å–®æ˜¯ç©ºçš„ ğŸƒ</div>';
            data.forEach(item => {
                list.innerHTML += `<div class="flex justify-between items-center bg-white p-4 rounded-2xl border border-[#EEE8D6] mb-1"><span class="font-bold text-[#6B5643] ml-2">${item.text}</span><button onclick="delListItem('${item.id}')" class="text-gray-300 hover:text-red-400 text-lg px-2">Ã—</button></div>`;
            });
        }

        // --- Render Day (æ›´æ–°ç‚ºè©³ç´°ç‰ˆé‚è¼¯) ---
        function renderDay(dayNum) {
            document.querySelectorAll('.day-tab').forEach(el => el.className = "px-5 py-2.5 bg-white rounded-2xl text-sm font-bold text-[#A69585] shadow-sm border border-transparent whitespace-nowrap transition-all day-tab");
            document.getElementById(`tab-day${dayNum}`).className = "px-5 py-2.5 bg-[#8DD27E] rounded-2xl text-sm font-bold text-white shadow-md border border-[#8DD27E] whitespace-nowrap transition-all transform scale-105 day-tab";
            
            const data = itineraryData[dayNum];
            const container = document.getElementById('day-content');
            
            // åŠ å…¥æ¨™é¡Œ
            let html = `<div class="mb-2 px-2"><h3 class="text-xl font-black text-[#6B5643]">${data.title}</h3></div>`;
            
            data.timeline.forEach(item => {
                // å°èˆªæŒ‰éˆ•
                const mapLink = item.mapQuery ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.mapQuery)}" target="_blank" class="inline-flex items-center mt-3 px-3 py-1.5 bg-[#70D3E8] text-white text-xs font-bold rounded-lg shadow-sm hover:bg-[#4DD0E1] transition">ğŸ—ºï¸ å°èˆª</a>` : '';
                
                // äº¤é€šå¡ç‰‡
                let transportCard = '';
                if(item.transport) {
                    transportCard = `<div class="transport-card"><div class="flex justify-between items-start mb-1"><span class="font-black text-[#006064] text-sm">${item.transport.mode}</span><span class="text-xs font-bold text-[#00838F] bg-white px-2 rounded-full border border-[#00838F]">${item.transport.duration}</span></div><div class="text-sm font-bold text-[#7C5E45] mb-1">${item.transport.route}</div><div class="text-xs text-[#0097A7]">ğŸ’¡ ${item.transport.note}</div></div>`;
                }

                // è²»ç”¨èˆ‡æ™‚é–“ Badge
                let costBadge = item.cost ? `<span class="text-[10px] font-bold text-[#FFB366] bg-[#FFF8E1] px-2 py-1 rounded border border-[#FFB366] mr-1">ğŸ’° ${item.cost}</span>` : '';
                let hoursBadge = item.hours ? `<span class="text-[10px] font-bold text-[#8DD27E] bg-[#E9F5E6] px-2 py-1 rounded border border-[#8DD27E]">ğŸ•’ ${item.hours}</span>` : '';

                html += `
                    <div class="flex relative pl-3 pb-2 group">
                        <div class="timeline-line"></div>
                        <div class="z-10 w-9 h-9 rounded-full bg-[#FFFDF6] border-4 border-[#8DD27E] flex items-center justify-center text-sm mr-4 shrink-0 timeline-dot shadow-sm">${item.icon}</div>
                        <div class="bg-white p-4 rounded-[1.2rem] border border-[#F0EAE0] flex-grow shadow-sm mb-2 hover:shadow-md transition">
                            <div class="flex justify-between items-baseline mb-1">
                                <span class="font-black text-[#6B5643] text-lg">${item.title}</span>
                                <span class="text-xs font-bold text-[#6BAF5C] bg-[#E9F5E6] px-2 py-1 rounded-lg">${item.time}</span>
                            </div>
                            <p class="text-xs text-[#A69585] font-bold leading-relaxed mb-2">${item.desc}</p>
                            <div class="mb-2">${costBadge}${hoursBadge}</div>
                            ${transportCard}
                            ${mapLink}
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
        }

        function updateDashboard() {
            let total = 0; expenses.forEach(e => total += (e.curr === 'JPY' ? Math.round(e.amt * RATE) : e.amt));
            document.getElementById('variable-spent').innerText = total.toLocaleString();
            document.getElementById('total-spent').innerText = (FIXED_COST + total).toLocaleString();
            const p = Math.min((total / (FIXED_COST + total)) * 100, 100);
            document.getElementById('variable-bar').style.width = p + '%';
        }

        function switchView(id) {
            document.querySelectorAll('main > section').forEach(el => { el.classList.add('hidden'); el.classList.remove('fade-in'); });
            const target = document.getElementById(`view-${id}`);
            if(target) { target.classList.remove('hidden'); target.classList.add('fade-in'); }
            
            document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('active'); el.style.color = '#C0B2A6'; });
            const btn = document.getElementById(`nav-${id}`);
            if(btn) { btn.classList.add('active'); btn.style.color = '#8DD27E'; }
            
            if(id === 'itinerary') renderDay(1);
            if(id === 'dashboard') updateDashboard();
        }
    </script>
</body>
</html>
