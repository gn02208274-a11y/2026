<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 å±±æ¢¨ç”²æ–æ—… (æ•‘æ´ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;800&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EğŸƒ%3C/text%3E%3C/svg%3E">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --ac-green: #78B159; --ac-cream: #FDFBF0; --ac-brown: #7C5E45; --ac-blue: #64C3D9; --ac-yellow: #F7E464; --ac-text: #594A3D; }
        body { font-family: 'M PLUS Rounded 1c', sans-serif; background-color: var(--ac-cream); color: var(--ac-text); background-image: radial-gradient(#E6F2D6 15%, transparent 16%), radial-gradient(#E6F2D6 15%, transparent 16%); background-size: 30px 30px; background-position: 0 0, 15px 15px; -webkit-tap-highlight-color: transparent; }
        .nook-card { background-color: white; border-radius: 1rem; box-shadow: 4px 4px 0 rgba(124, 94, 69, 0.1); border: 2px solid #E0E0E0; transition: transform 0.1s; }
        .nook-card:active { transform: scale(0.98); }
        .nook-btn { border-radius: 9999px; font-weight: 800; transition: all 0.1s; cursor: pointer; user-select: none; }
        .nook-btn:active { transform: scale(0.95); }
        
        /* Loading Overlay with fallback pointer-events */
        #loading-overlay { position: fixed; inset: 0; background: #78B159; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; pointer-events: auto; }
        #loading-overlay.fade-out { opacity: 0; pointer-events: none; }
        .spinner { width: 40px; height: 40px; border: 4px solid #FDFBF0; border-top-color: #F7E464; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: rgba(255,255,255,0.6); font-size: 0.7rem; font-weight: bold; transition: all 0.2s; }
        .nav-item.active { color: white; transform: translateY(-2px); }
        .nav-icon { font-size: 1.2rem; margin-bottom: 2px; }
        .timeline-line { position: absolute; left: 1rem; top: 0; bottom: 0; border-left: 2px dashed #ccc; z-index: 0; }
        .transport-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #E0F7FA; color: #006064; font-weight: bold; border: 1px solid #4DD0E1; display: inline-block; margin-top: 4px; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: flex; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(4px); }
        .modal-content { background: #FDFBF0; border-radius: 1.5rem; padding: 2rem; width: 100%; max-width: 360px; border: 4px solid #F7E464; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- Loading Screen -->
    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <div class="text-white font-bold text-xl tracking-widest">Nook Travel</div>
        <div class="text-white/80 text-xs mt-2">è¼‰å…¥ä¸­...</div>
        <!-- ç·Šæ€¥æŒ‰éˆ•ï¼šå¦‚æœå¡ä½è¶…é3ç§’æœƒè‡ªå‹•é¡¯ç¤º -->
        <button onclick="forceUnlock()" id="emergency-btn" class="hidden mt-8 text-[10px] text-white underline bg-black/20 px-2 py-1 rounded">å¡ä½äº†ï¼Ÿé»æ­¤å¼·åˆ¶é€²å…¥</button>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal hidden">
        <div class="modal-content text-center">
            <div class="text-4xl mb-4">ğŸƒ</div>
            <h2 class="text-xl font-black text-[#7C5E45] mb-2">é–‹å§‹æ—…ç¨‹</h2>
            <p class="text-sm text-gray-500 mb-6 font-bold">è«‹è¼¸å…¥ä»£ç¢¼ä»¥åŒæ­¥è³‡æ–™</p>
            
            <input type="text" id="travel-id-input" placeholder="æ—…è²»ä»£ç¢¼ (ä¾‹: Trip2026)" class="w-full bg-white border-2 border-gray-300 rounded-xl p-3 text-center font-bold text-lg mb-4 outline-none focus:border-[#78B159] uppercase">
            
            <button onclick="saveTravelId()" class="w-full bg-[#78B159] text-white font-black py-3 rounded-xl shadow-md nook-btn text-lg hover:bg-[#689F4D]">ğŸš€ å‡ºç™¼ï¼</button>
            
            <div class="mt-6 pt-4 border-t border-gray-200">
                <button onclick="toggleConfigPanel()" class="text-xs text-gray-400 font-bold underline">è¨­å®šé›²ç«¯è³‡æ–™åº«</button>
                <button onclick="resetAll()" class="text-[10px] text-red-400 ml-4 hover:text-red-600">é‡ç½®æ‰€æœ‰è¨­å®š</button>
            </div>
            
            <div id="config-panel" class="hidden mt-3 text-left bg-gray-100 p-3 rounded-lg">
                <p class="text-xs text-gray-500 mb-2">è«‹è²¼ä¸Š Firebase Config:</p>
                <textarea id="config-input" class="w-full h-24 text-[10px] p-2 rounded border" placeholder="{ apiKey: ... }"></textarea>
                <button onclick="saveConfig()" class="w-full mt-2 bg-[#F7E464] text-[#7C5E45] font-bold py-2 rounded text-xs">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-[#78B159] text-white h-14 flex items-center justify-between px-4 shadow-md z-10 flex-none">
        <div class="font-black text-lg tracking-wider flex items-center">
            <span class="mr-2">ğŸƒ</span> 2026 å±±æ¢¨æ—…
        </div>
        <button onclick="copyShareLink()" class="bg-black/20 px-3 py-1 rounded-full text-xs font-bold hover:bg-black/30 transition flex items-center">
            <span id="header-id">ID: --</span>
        </button>
    </header>

    <!-- Main Content -->
    <main id="main-container" class="flex-grow overflow-y-auto bg-[#FDFBF0] p-4 pb-24 space-y-6 hidden">
        <!-- Dashboard -->
        <section id="view-dashboard" class="fade-in">
            <div class="nook-card p-5 border-t-4 border-[#F7E464] mb-4">
                <div class="flex justify-between items-end mb-2">
                    <h2 class="font-bold text-[#7C5E45]">ğŸ’° ç¸½æ”¯å‡º</h2>
                    <span class="text-2xl font-black text-[#E65100]" id="total-spent">--</span>
                </div>
                <div class="h-3 bg-gray-100 rounded-full overflow-hidden flex mb-2">
                    <div class="bg-[#78B159] w-1/2 h-full"></div>
                    <div class="bg-[#FFB74D] w-0 h-full transition-all duration-700" id="variable-bar"></div>
                </div>
                <div class="flex justify-between text-xs font-bold text-gray-500">
                    <span>å·²ä»˜: 36,046</span>
                    <span class="text-[#E65100]">æµ®å‹•: <span id="variable-spent">0</span></span>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div onclick="switchView('accounting')" class="nook-card p-4 flex flex-col items-center justify-center bg-[#FFFDE7]"><span class="text-2xl mb-1">ğŸ“</span><span class="font-bold text-[#7C5E45] text-sm">è¨˜ä¸€ç­†</span></div>
                <div onclick="switchView('lists')" class="nook-card p-4 flex flex-col items-center justify-center bg-[#E0F2F1]"><span class="text-2xl mb-1">ğŸ’</span><span class="font-bold text-[#00695C] text-sm">æ¸…å–®</span></div>
            </div>
            <div class="nook-card p-4 border-l-4 border-[#64C3D9]" onclick="switchView('transport')"><h3 class="font-bold text-[#006064] text-sm mb-1">ğŸšŒ é‡é»äº¤é€šæé†’</h3><p class="text-xs text-gray-600">Day 3 ç§»å‹•æ—¥: çŸ³å’Œæº«æ³‰ â†’ æ²³å£æ¹–</p><div class="text-lg font-black text-[#E65100] mt-1">10:08 ç™¼è»Š (ç›´é”)</div></div>
        </section>

        <!-- Itinerary -->
        <section id="view-itinerary" class="hidden fade-in">
            <div class="flex overflow-x-auto space-x-2 pb-2 mb-2 no-scrollbar">
                <button onclick="renderDay(1)" class="px-4 py-2 bg-white rounded-full text-sm font-bold text-gray-500 border whitespace-nowrap day-tab" id="tab-day1">Day 1</button>
                <button onclick="renderDay(2)" class="px-4 py-2 bg-white rounded-full text-sm font-bold text-gray-500 border whitespace-nowrap day-tab" id="tab-day2">Day 2</button>
                <button onclick="renderDay(3)" class="px-4 py-2 bg-white rounded-full text-sm font-bold text-gray-500 border whitespace-nowrap day-tab" id="tab-day3">Day 3</button>
                <button onclick="renderDay(4)" class="px-4 py-2 bg-white rounded-full text-sm font-bold text-gray-500 border whitespace-nowrap day-tab" id="tab-day4">Day 4</button>
                <button onclick="renderDay(5)" class="px-4 py-2 bg-white rounded-full text-sm font-bold text-gray-500 border whitespace-nowrap day-tab" id="tab-day5">Day 5</button>
            </div>
            <div id="day-content" class="space-y-4"></div>
        </section>

        <!-- Accounting -->
        <section id="view-accounting" class="hidden fade-in space-y-4">
            <div class="nook-card p-4 bg-white sticky top-0 z-10 shadow-sm border-t-4 border-[#78B159]">
                <div class="grid grid-cols-4 gap-2 mb-2">
                    <select id="acc-cat" class="col-span-1 bg-[#F1F8E9] rounded-lg text-sm p-2 font-bold text-[#558B2F] outline-none"><option>é£Ÿ</option><option>è¡Œ</option><option>æ¨‚</option><option>è²·</option><option>ä½</option></select>
                    <input type="text" id="acc-item" placeholder="é …ç›®" class="col-span-3 bg-gray-50 border border-gray-200 rounded-lg p-2 text-sm outline-none">
                </div>
                <div class="flex gap-2 mb-2">
                    <input type="number" id="acc-amt" placeholder="é‡‘é¡" class="flex-grow bg-gray-50 border border-gray-200 rounded-lg p-2 text-sm outline-none" inputmode="decimal">
                    <select id="acc-curr" class="bg-[#FFF9C4] rounded-lg text-sm px-3 font-bold text-[#E65100] outline-none"><option value="JPY">Â¥</option><option value="TWD">$</option></select>
                </div>
                <button onclick="addExpense()" class="w-full bg-[#78B159] text-white font-bold py-3 rounded-xl shadow active:bg-[#689F4D]">ï¼‹ æ–°å¢ç´€éŒ„</button>
            </div>
            <div id="expense-list" class="space-y-3 pb-10"></div>
        </section>

        <!-- Lists -->
        <section id="view-lists" class="hidden fade-in space-y-4">
            <div class="flex gap-2 mb-2">
                <button onclick="listMode='pack'; renderLists()" class="flex-1 py-2 rounded-xl font-bold transition bg-[#FFF3E0] text-[#E65100] border-2 border-[#FFCC80]" id="btn-pack">ğŸ’ å¿…å¸¶</button>
                <button onclick="listMode='shop'; renderLists()" class="flex-1 py-2 rounded-xl font-bold transition bg-white text-gray-400 border-2 border-gray-100" id="btn-shop">ğŸ›ï¸ è³¼ç‰©</button>
            </div>
            <div class="flex gap-2">
                <input type="text" id="list-input" class="flex-grow p-3 rounded-xl border-2 border-gray-200 outline-none" placeholder="æ–°å¢...">
                <button onclick="addListItem()" class="bg-[#78B159] text-white w-12 rounded-xl font-bold text-xl shadow">+</button>
            </div>
            <div id="list-container" class="space-y-2 pb-10"></div>
        </section>

        <!-- Transport & Info -->
        <section id="view-info" class="hidden fade-in space-y-4">
            <div class="nook-card p-4 border-l-4 border-[#64C3D9]">
                <h3 class="font-bold text-[#006064] mb-2">ğŸšŒ æ²³å£æ¹–å‘¨éŠå·´å£«</h3>
                <div class="text-sm space-y-2">
                    <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-red-500 mr-2"></span><span>ç´…ç·š: æ¯15åˆ†ä¸€ç­ (å»é£¯åº—/çºœè»Š)</span></div>
                    <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-green-500 mr-2"></span><span>ç¶ ç·š: å»è¥¿æ¹–æ ¹å ´</span></div>
                </div>
            </div>
            <div class="nook-card p-4 border-l-4 border-[#B8860B]">
                <h3 class="font-bold text-[#7C5E45] mb-2">ğŸ¡ ä½å®¿è³‡è¨Š</h3>
                <div class="mb-2"><div class="font-bold text-sm">ãƒ•ã‚¯ãƒ­ã‚¦ã®å¾¡å®¿ (å‰2æ™š)</div><div class="text-xs text-gray-500">çŸ³å’Œæº«æ³‰ç«™æ­è¨ˆç¨‹è»Šç´„10åˆ†</div></div>
                <div><div class="font-bold text-sm">HOTORI no HOTEL (å¾Œ2æ™š)</div><div class="text-xs text-gray-500">ç´…ç·šå·´å£«ã€ŒéŸ³æ¨‚ç›’ä¹‹æ£®ã€ç«™æ—</div></div>
            </div>
        </section>
    </main>

    <!-- Bottom Nav -->
    <nav class="bg-white h-16 border-t border-gray-200 flex justify-around items-center px-2 z-20 flex-none pb-[env(safe-area-inset-bottom)]">
        <button onclick="switchView('dashboard')" class="nav-item text-[#78B159]" id="nav-dashboard"><span class="nav-icon">ğŸ“Š</span>ç¸½è¦½</button>
        <button onclick="switchView('itinerary')" class="nav-item text-gray-400" id="nav-itinerary"><span class="nav-icon">ğŸ“…</span>è¡Œç¨‹</button>
        <button onclick="switchView('accounting')" class="nav-item text-gray-400" id="nav-accounting"><span class="nav-icon">ğŸ’°</span>è¨˜å¸³</button>
        <button onclick="switchView('lists')" class="nav-item text-gray-400" id="nav-lists"><span class="nav-icon">ğŸ“</span>æ¸…å–®</button>
        <button onclick="switchView('info')" class="nav-item text-gray-400" id="nav-info"><span class="nav-icon">ğŸ’¡</span>è³‡è¨Š</button>
    </nav>

    <script>
        const FIXED_COST = 36046;
        const RATE = 0.215;
        let db, auth, appId;
        let expenses = [], packList = [], shopList = [], listMode = 'pack';

        const itinerary = {
            1: [{t:"10:35",i:"ğŸ›¬",h:"æŠµé”æˆç”°",d:"IT200 æŠµé”"},{t:"11:44",i:"ğŸš†",h:"N'EX å¾€æ–°å®¿",d:"9/10æœˆå°æ­ä¹˜"},{t:"13:30",i:"ğŸš„",h:"è½‰ä¹˜ Kaiji",d:"æ–°å®¿è½‰ç‰¹æ€¥å¾€çŸ³å’Œæº«æ³‰"},{t:"15:00",i:"ğŸ¡",h:"Check-in",d:"æ­è¨ˆç¨‹è»Šè‡³å¤æ°‘å®¶"}],
            2: [{t:"09:00",i:"ğŸ¯",h:"æƒ æ—å¯º",d:"æ­¦ç”°ä¿¡ç„å¢“æ‰€"},{t:"11:00",i:"ğŸ“",h:"è‰è“åƒåˆ°é£½",d:"Gourmet è‹ºå‰ç”°"},{t:"13:30",i:"ğŸï¸",h:"æ˜‡ä»™å³½",d:"çµ•ç¾æºªè°·å¥è¡Œ"},{t:"18:30",i:"ğŸ·",h:"ç”²åºœæ™šé¤",d:"å¯Œå£«æ«»è±¬ç‚¸è±¬æ’"}],
            3: [{t:"10:08",i:"ğŸšŒ",h:"ç§»å‹•æ—¥(å¿…æ­)",d:"çŸ³å’Œæº«æ³‰ç™¼è»Šå¾€æ²³å£æ¹–"},{t:"12:00",i:"ğŸ˜ï¸",h:"è¥¿æ¹–æ ¹å ´",d:"åˆæŒé€ èšè½"},{t:"15:00",i:"ğŸŒ¸",h:"å¤§çŸ³å…¬åœ’",d:"ç´…ç·šå·´å£«çµ‚é»"},{t:"16:30",i:"ğŸ¨",h:"å…¥ä½ HOTORI",d:"é¢æ¹–æˆ¿å‹"}],
            4: [{t:"09:00",i:"â›©ï¸",h:"å¤©ç©ºé³¥å±…",d:"æ­è¨ˆç¨‹è»Šä¸Šå±±"},{t:"11:30",i:"ğŸœ",h:"Hoto Fudo",d:"é¤ºé£¥éºµåˆé¤"},{t:"14:00",i:"ğŸš ",h:"å¤©ä¸Šå±±çºœè»Š",d:"ä¿¯ç°æ²³å£æ¹–"},{t:"16:00",i:"ğŸ¨",h:"ä¹…ä¿ç”°ä¸€ç«¹",d:"å’Œæœç¾è¡“é¤¨"}],
            5: [{t:"11:00",i:"ğŸ‘‹",h:"é€€æˆ¿",d:"å‰å¾€æ²³å£æ¹–ç«™"},{t:"13:00",i:"ğŸš†",h:"å¯Œå£«å›éŠ",d:"ç›´é”æ–°å®¿"},{t:"17:00",i:"ğŸ›«",h:"å‰å¾€æ©Ÿå ´",d:"N'EX å¾€æˆç”°"},{t:"20:25",i:"âœˆï¸",h:"è¿”å°",d:"IT203"}]
        };

        // Safety Valve: Force unlock if stuck
        setTimeout(() => {
            const overlay = document.getElementById('loading-overlay');
            if(overlay && !overlay.classList.contains('hidden') && !overlay.classList.contains('fade-out')) {
                document.getElementById('emergency-btn').classList.remove('hidden');
            }
        }, 3000);

        document.addEventListener('DOMContentLoaded', async () => {
            const urlId = new URLSearchParams(window.location.search).get('id');
            if(urlId) document.getElementById('travel-id-input').value = urlId;
            try {
                await checkLogin(urlId);
            } catch(e) {
                console.error("Critical Init Error:", e);
                forceUnlock();
            }
        });

        async function checkLogin(urlId) {
            const savedId = localStorage.getItem('nook_travel_id');
            const savedConfig = localStorage.getItem('nook_firebase_config');
            const targetId = urlId || savedId;
            
            if (targetId && savedConfig) {
                appId = targetId;
                localStorage.setItem('nook_travel_id', appId);
                document.getElementById('header-id').innerText = `ID: ${appId}`;
                
                try {
                    await initFirebase(JSON.parse(savedConfig));
                    // Success path
                    document.getElementById('login-modal').classList.add('hidden');
                    document.getElementById('main-container').classList.remove('hidden');
                    switchView('dashboard');
                    const overlay = document.getElementById('loading-overlay');
                    overlay.classList.add('fade-out');
                    setTimeout(() => overlay.classList.add('hidden'), 500);
                } catch(e) {
                    // Config corrupted
                    alert("è¨­å®šæª”ä¼¼ä¹æœ‰å•é¡Œï¼Œè«‹é‡æ–°è¨­å®šã€‚");
                    resetAll();
                }
            } else {
                // Not logged in
                const overlay = document.getElementById('loading-overlay');
                overlay.classList.add('fade-out');
                setTimeout(() => overlay.classList.add('hidden'), 500);
                document.getElementById('login-modal').classList.remove('hidden');
            }
        }

        function forceUnlock() {
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('login-modal').classList.remove('hidden');
        }

        async function initFirebase(config) {
            if (!window.firebase) throw new Error("Firebase SDKæœªè¼‰å…¥");
            if (!firebase.apps.length) firebase.initializeApp(config);
            auth = firebase.auth();
            db = firebase.firestore();
            await auth.signInAnonymously();
            setupListeners();
        }

        function setupListeners() {
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('expenses').orderBy('time', 'desc')
                .onSnapshot(snap => {
                    expenses = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    renderAccounting(); updateDashboard();
                });
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('lists').orderBy('time', 'asc')
                .onSnapshot(snap => {
                    const all = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    packList = all.filter(i => i.type === 'pack');
                    shopList = all.filter(i => i.type === 'shop');
                    renderLists();
                });
        }

        function saveTravelId() {
            const id = document.getElementById('travel-id-input').value.trim();
            if(!localStorage.getItem('nook_firebase_config')) return alert('è«‹å…ˆè¨­å®šé›²ç«¯è³‡æ–™åº«ï¼');
            if(!id) return alert('è«‹è¼¸å…¥ä»£ç¢¼');
            localStorage.setItem('nook_travel_id', id);
            location.href = window.location.pathname;
        }

        function saveConfig() {
            let raw = document.getElementById('config-input').value.trim();
            try {
                raw = raw.replace(/\/\/.*$/gm, '').replace(/[\u2018\u2019]/g, "'").replace(/[\u201C\u201D]/g, '"');
                if(raw.includes('=')) raw = raw.substring(raw.indexOf('=') + 1).trim();
                if(raw.endsWith(';')) raw = raw.slice(0, -1).trim();
                let jsonStr = raw.replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:/g, '"$2":').replace(/,(\s*})/g, '$1');
                if(!jsonStr.startsWith('{')) jsonStr = '{' + jsonStr + '}';
                
                const config = JSON.parse(jsonStr);
                if(!config.apiKey) throw new Error("ç¼ºå°‘ apiKey");
                
                localStorage.setItem('nook_firebase_config', JSON.stringify(config));
                alert('è¨­å®šæˆåŠŸï¼');
                location.reload();
            } catch(e) {
                alert('æ ¼å¼éŒ¯èª¤: ' + e.message);
            }
        }

        function resetAll() {
            if(confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è¨­å®šå—ï¼Ÿ')) {
                localStorage.removeItem('nook_travel_id');
                localStorage.removeItem('nook_firebase_config');
                location.reload();
            }
        }

        function copyShareLink() {
            const url = window.location.href.split('?')[0] + '?id=' + appId;
            navigator.clipboard.writeText(url).then(() => alert('é€£çµå·²è¤‡è£½ï¼'));
        }

        function addExpense() {
            const item = document.getElementById('acc-item').value;
            const amt = document.getElementById('acc-amt').value;
            if(!item || !amt) return;
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('expenses').add({
                time: Date.now(),
                cat: document.getElementById('acc-cat').value,
                item, amt: parseFloat(amt),
                curr: document.getElementById('acc-curr').value
            });
            document.getElementById('acc-item').value = '';
            document.getElementById('acc-amt').value = '';
        }

        function delExpense(id) {
            // ç›´æ¥åˆªé™¤ï¼Œä¸ç¢ºèª
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('expenses').doc(id).delete();
        }

        function addListItem() {
            const val = document.getElementById('list-input').value;
            if(!val) return;
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('lists').add({
                time: Date.now(), text: val, type: listMode, checked: false
            });
            document.getElementById('list-input').value = '';
        }

        function delListItem(id) {
            // ç›´æ¥åˆªé™¤ï¼Œä¸ç¢ºèª
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('lists').doc(id).delete();
        }

        function renderAccounting() {
            const list = document.getElementById('expense-list');
            list.innerHTML = '';
            if(expenses.length === 0) return list.innerHTML = '<div class="text-center text-gray-400 py-8 text-sm">é‚„æ²’æœ‰è¨˜å¸³å–”</div>';
            
            expenses.forEach(ex => {
                const twd = ex.curr === 'JPY' ? Math.round(ex.amt * RATE) : ex.amt;
                list.innerHTML += `
                    <div class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-[#F1F8E9] flex items-center justify-center mr-3 text-sm">${ex.cat[0]}</div>
                            <div>
                                <div class="font-bold text-[#594A3D] text-sm">${ex.item}</div>
                                <div class="text-xs text-gray-400">${ex.amt.toLocaleString()} ${ex.curr}</div>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <span class="font-bold text-[#E65100] text-sm mr-3">$${twd.toLocaleString()}</span>
                            <button onclick="delExpense('${ex.id}')" class="text-gray-300 w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 hover:text-red-500">Ã—</button>
                        </div>
                    </div>`;
            });
        }

        function renderLists() {
            const list = document.getElementById('list-container');
            const data = listMode === 'pack' ? packList : shopList;
            
            document.getElementById('btn-pack').className = `flex-1 py-2 rounded-xl font-bold transition border-2 ${listMode==='pack' ? 'bg-[#FFF3E0] text-[#E65100] border-[#FFCC80]' : 'bg-white text-gray-400 border-gray-100'}`;
            document.getElementById('btn-shop').className = `flex-1 py-2 rounded-xl font-bold transition border-2 ${listMode==='shop' ? 'bg-[#E0F2F1] text-[#00695C] border-[#80CBC4]' : 'bg-white text-gray-400 border-gray-100'}`;

            list.innerHTML = '';
            if(data.length === 0) return list.innerHTML = '<div class="text-center text-gray-400 py-8 text-sm">æ¸…å–®æ˜¯ç©ºçš„</div>';

            data.forEach(item => {
                list.innerHTML += `
                    <div class="flex justify-between items-center bg-white p-3 rounded-xl border border-gray-100">
                        <span class="font-bold text-[#594A3D] ml-2">${item.text}</span>
                        <button onclick="delListItem('${item.id}')" class="text-gray-300 w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 hover:text-red-500">Ã—</button>
                    </div>`;
            });
        }

        function renderDay(day) {
            document.querySelectorAll('.day-tab').forEach(el => el.className = "px-4 py-2 bg-white rounded-full text-sm font-bold text-gray-500 border whitespace-nowrap day-tab");
            document.getElementById(`tab-day${day}`).className = "px-4 py-2 bg-[#78B159] rounded-full text-sm font-bold text-white border border-[#78B159] whitespace-nowrap day-tab";
            
            const container = document.getElementById('day-content');
            container.innerHTML = '';
            
            itinerary[day].forEach(item => {
                container.innerHTML += `
                    <div class="flex relative pl-2">
                        <div class="timeline-line"></div>
                        <div class="z-10 w-8 h-8 rounded-full bg-[#FDFBF0] border-2 border-[#78B159] flex items-center justify-center text-sm mr-3 shrink-0">${item.i}</div>
                        <div class="bg-white p-3 rounded-2xl border border-gray-200 flex-grow shadow-sm mb-1">
                            <div class="flex justify-between items-baseline mb-1">
                                <span class="font-black text-[#7C5E45]">${item.h}</span>
                                <span class="text-xs font-bold text-[#78B159] bg-[#F1F8E9] px-2 py-0.5 rounded-full">${item.t}</span>
                            </div>
                            <p class="text-xs text-gray-500">${item.d}</p>
                        </div>
                    </div>`;
            });
        }

        function updateDashboard() {
            let total = 0;
            expenses.forEach(e => total += (e.curr === 'JPY' ? Math.round(e.amt * RATE) : e.amt));
            document.getElementById('variable-spent').innerText = total.toLocaleString();
            document.getElementById('total-spent').innerText = (FIXED_COST + total).toLocaleString();
            
            const p = Math.min((total / (FIXED_COST + total)) * 100, 100);
            document.getElementById('variable-bar').style.width = p + '%';
        }

        function switchView(id) {
            document.querySelectorAll('main > section').forEach(el => { el.classList.add('hidden'); el.classList.remove('fade-in'); });
            const target = document.getElementById(`view-${id}`);
            if(target) { target.classList.remove('hidden'); target.classList.add('fade-in'); }
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.replace('text-[#78B159]', 'text-gray-400'));
            const btn = document.getElementById(`nav-${id}`);
            if(btn) btn.classList.replace('text-gray-400', 'text-[#78B159]');
            
            if(id === 'itinerary') renderDay(1);
            if(id === 'dashboard') updateDashboard();
        }

        function toggleConfigPanel() { document.getElementById('config-panel').classList.toggle('hidden'); }
    </script>
</body>
</html>
