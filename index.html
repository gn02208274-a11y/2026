<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2026 å±±æ¢¨ç”²æ–æ—… (ç¾åŒ–ç‰ˆ)</title>
    
    <!-- éŒ¯èª¤æ””æˆª (ä¿ç•™ä»¥å‚™ä¸æ™‚ä¹‹éœ€) -->
    <script>
        window.onerror = function(msg, url, line) {
            console.error("Error: " + msg);
            return false; 
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EğŸƒ%3C/text%3E%3C/svg%3E">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* å¼·åˆ¶éš±è— */
        .hidden { display: none !important; }
        
        :root { 
            --ac-green: #8DD27E; 
            --ac-green-dark: #6BAF5C;
            --ac-cream: #FFFDF6; 
            --ac-brown: #796652; 
            --ac-blue: #70D3E8; 
            --ac-yellow: #F9E776; 
            --ac-orange: #FFB366;
        }
        
        body { 
            font-family: 'M PLUS Rounded 1c', sans-serif; 
            background-color: var(--ac-cream); 
            color: var(--ac-brown); 
            /* æ›´ç´°ç·»çš„è‰åœ°èƒŒæ™¯ */
            background-image: radial-gradient(#E9F5E6 20%, transparent 20%), radial-gradient(#E9F5E6 20%, transparent 20%);
            background-size: 30px 30px; 
            background-position: 0 0, 15px 15px;
            -webkit-tap-highlight-color: transparent; 
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* æ ¸å¿ƒå¡ç‰‡ - è¶…åœ“è§’ + æŸ”å’Œé™°å½± */
        .nook-card { 
            background-color: rgba(255, 255, 255, 0.95); 
            border-radius: 1.5rem; 
            box-shadow: 0 8px 20px -6px rgba(121, 102, 82, 0.1); 
            border: 2px solid #F0EAE0; 
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            backdrop-filter: blur(8px);
        }
        .nook-card:active { transform: scale(0.98); }
        
        /* ç«‹é«”æŒ‰éˆ• (Pop Button) */
        .nook-btn { 
            border-radius: 9999px; 
            font-weight: 800; 
            transition: all 0.1s; 
            cursor: pointer; 
            user-select: none; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.15); /* ç«‹é«”é™°å½± */
            transform: translateY(0);
        }
        .nook-btn:active { 
            transform: translateY(4px); /* æŒ‰ä¸‹æ™‚ä¸‹æ²‰ */
            box-shadow: 0 0 0 rgba(0,0,0,0); /* é™°å½±æ¶ˆå¤± */
        }
        
        /* åº•éƒ¨å°è¦½åˆ— - æ‡¸æµ®ç»ç’ƒå³¶å¶¼ */
        .nav-island {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-radius: 2rem;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.5);
            margin: 0 1rem 1rem 1rem;
        }
        
        .nav-item { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            color: #C0B2A6; font-size: 0.65rem; font-weight: bold; transition: all 0.3s; 
            position: relative;
        }
        .nav-item.active { color: var(--ac-green-dark); transform: translateY(-4px); }
        .nav-item.active .nav-icon { transform: scale(1.2); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 2px; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        
        /* è¡Œç¨‹æ™‚é–“è»¸ç¾åŒ– */
        .timeline-line { position: absolute; left: 1.15rem; top: 1rem; bottom: -1rem; border-left: 3px dotted #DCD0C0; z-index: 0; }
        .timeline-dot { box-shadow: 0 0 0 4px #FDFBF0; } /* è®“ç·šæ¢ä¸åˆ‡åˆ°åœ“é» */

        /* äº¤é€šæ¨™ç±¤ */
        .transport-badge { 
            font-size: 0.7rem; padding: 4px 8px; border-radius: 8px; 
            background: #E0F7FA; color: #00838F; font-weight: 800; 
            border: 1px dashed #4DD0E1; display: inline-block; margin-top: 6px; 
        }

        /* æ¨¡æ…‹è¦–çª—å‹•ç•« */
        .modal { position: fixed; inset: 0; background: rgba(121, 102, 82, 0.4); z-index: 1000; display: flex; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(4px); }
        .modal-content { 
            background: #FFFDF6; border-radius: 2rem; padding: 2rem; width: 100%; max-width: 340px; 
            border: 4px solid var(--ac-yellow); 
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); 
            animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
        }
        @keyframes bounceIn { 
            0% { transform: scale(0.8); opacity: 0; } 
            100% { transform: scale(1); opacity: 1; } 
        }

        /* è¼¸å…¥æ¡†ç¾åŒ– */
        .cute-input {
            width: 100%; border: 2px solid #EEE8D6; background: #FFF;
            border-radius: 1rem; padding: 0.8rem; outline: none;
            transition: border-color 0.2s; color: var(--ac-brown); font-weight: bold;
        }
        .cute-input:focus { border-color: var(--ac-yellow); }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden text-[#796652]">

    <!-- Login Modal -->
    <div id="login-modal" class="modal hidden">
        <div class="modal-content text-center relative overflow-hidden">
            <!-- è£é£¾èƒŒæ™¯ -->
            <div class="absolute top-[-20px] left-[-20px] w-20 h-20 bg-[#F9E776] rounded-full opacity-20"></div>
            <div class="absolute bottom-[-20px] right-[-20px] w-24 h-24 bg-[#8DD27E] rounded-full opacity-20"></div>
            
            <div class="relative z-10">
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-[#8DD27E] shadow-sm text-3xl">ğŸƒ</div>
                <h2 class="text-2xl font-black text-[#6B5643] mb-1">é–‹å§‹æ—…ç¨‹</h2>
                <p class="text-sm text-[#A69585] mb-6 font-bold">åŒæ­¥æ‚¨çš„ 2026 å±±æ¢¨ä¹‹æ—…</p>
                
                <input type="text" id="travel-id-input" placeholder="è¼¸å…¥æ—…è²»ä»£ç¢¼ (ä¾‹: Trip2026)" class="cute-input text-center text-lg mb-4 uppercase tracking-widest placeholder:tracking-normal">
                
                <button onclick="saveTravelId(this)" class="w-full bg-[#8DD27E] text-white py-3 text-lg nook-btn mb-6">ğŸš€ å‡ºç™¼ï¼</button>
                
                <div class="border-t border-[#EEE8D6] pt-4">
                    <button onclick="toggleConfigPanel()" class="text-xs text-[#A69585] font-bold hover:text-[#8DD27E] transition">ğŸ› ï¸ è¨­å®šé›²ç«¯è³‡æ–™åº« (åˆæ¬¡å¿…é»)</button>
                    <div class="mt-2"><button onclick="resetAll()" class="text-[10px] text-red-300 hover:text-red-500">é‡ç½® App</button></div>
                </div>
            </div>
            
            <!-- Config Panel -->
            <div id="config-panel" class="hidden mt-4 text-left bg-white p-3 rounded-xl border-2 border-[#EEE8D6] relative z-10">
                <p class="text-xs text-gray-400 mb-2 font-bold">è²¼ä¸Š Firebase Config:</p>
                <textarea id="config-input" class="w-full h-20 text-[10px] p-2 rounded-lg bg-[#FAFAFA] border border-gray-200 resize-none outline-none focus:border-[#F9E776]" placeholder="{ apiKey: ... }"></textarea>
                <button onclick="saveConfig(this)" class="w-full mt-2 bg-[#F9E776] text-[#796652] font-bold py-2 rounded-lg text-xs nook-btn">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md h-16 flex items-center justify-between px-5 z-10 flex-none sticky top-0 border-b border-white/50">
        <div class="font-black text-xl tracking-wider flex items-center text-[#6B5643]">
            <span class="mr-2 text-2xl">ğŸƒ</span> 2026 å±±æ¢¨
        </div>
        <button onclick="copyShareLink()" class="bg-[#F0EAE0] px-3 py-1.5 rounded-full text-xs font-bold text-[#796652] hover:bg-[#E0D8CC] transition flex items-center">
            <span id="header-id" class="mr-1">ID: --</span> ğŸ“‹
        </button>
    </header>

    <!-- Main Content -->
    <main id="main-container" class="flex-grow overflow-y-auto p-5 pb-32 space-y-6 hidden custom-scroll">
        
        <!-- Dashboard -->
        <section id="view-dashboard" class="fade-in space-y-5">
            <!-- Budget Card -->
            <div class="nook-card p-6 border-t-[6px] border-[#F9E776] relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl">ğŸ’°</div>
                <div class="flex justify-between items-end mb-3 relative z-10">
                    <div>
                        <h2 class="text-sm font-bold text-[#A69585]">ç¸½æ”¯å‡º (TWD)</h2>
                        <span class="text-3xl font-black text-[#FFB366]" id="total-spent">--</span>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-bold bg-[#E9F5E6] text-[#6BAF5C] px-2 py-1 rounded-lg mb-1">é ç®—ç›£æ§ä¸­</div>
                    </div>
                </div>
                <!-- Pill Progress Bar -->
                <div class="h-4 bg-[#F0EAE0] rounded-full overflow-hidden flex mb-3 shadow-inner">
                    <div class="bg-[#8DD27E] w-1/2 h-full rounded-r-sm" title="å›ºå®šæ”¯å‡º"></div>
                    <div class="bg-[#FFB366] w-0 h-full transition-all duration-1000 ease-out rounded-r-full" id="variable-bar" title="æµ®å‹•æ”¯å‡º"></div>
                </div>
                <div class="flex justify-between text-xs font-bold text-[#A69585]">
                    <span>âœˆï¸ å›ºå®š: 36,046</span>
                    <span class="text-[#FFB366]">ğŸ”¥ æµ®å‹•: <span id="variable-spent">0</span></span>
                </div>
            </div>

            <!-- Action Grid -->
            <div class="grid grid-cols-2 gap-4">
                <div onclick="switchView('accounting')" class="nook-card p-4 flex flex-col items-center justify-center bg-white cursor-pointer active:scale-95 transition-transform h-28 border-b-[4px] border-[#EEE8D6]">
                    <span class="text-3xl mb-2">ğŸ“</span><span class="font-black text-[#796652]">è¨˜ä¸€ç­†</span>
                </div>
                <div onclick="switchView('lists')" class="nook-card p-4 flex flex-col items-center justify-center bg-white cursor-pointer active:scale-95 transition-transform h-28 border-b-[4px] border-[#EEE8D6]">
                    <span class="text-3xl mb-2">ğŸ’</span><span class="font-black text-[#009688]">æ¸…å–®</span>
                </div>
            </div>

            <!-- Highlight -->
            <div class="nook-card p-5 border-l-[6px] border-[#70D3E8] flex items-center justify-between cursor-pointer" onclick="switchView('transport')">
                <div>
                    <h3 class="font-bold text-[#00838F] text-xs mb-1 uppercase tracking-wide">Next Highlight</h3>
                    <div class="text-lg font-black text-[#6B5643]">Day 3 å·´å£«ç§»å‹•</div>
                    <p class="text-xs text-[#A69585] mt-1">10:08 çŸ³å’Œæº«æ³‰ â†’ æ²³å£æ¹–</p>
                </div>
                <div class="text-3xl">ğŸšŒ</div>
            </div>
        </section>

        <!-- Itinerary -->
        <section id="view-itinerary" class="hidden fade-in">
            <!-- Tabs -->
            <div class="flex overflow-x-auto space-x-3 pb-2 mb-4 no-scrollbar px-1">
                <button onclick="renderDay(1)" class="px-5 py-2.5 bg-white rounded-2xl text-sm font-bold text-[#A69585] shadow-sm border border-transparent whitespace-nowrap transition-all day-tab" id="tab-day1">Day 1</button>
                <button onclick="renderDay(2)" class="px-5 py-2.5 bg-white rounded-2xl text-sm font-bold text-[#A69585] shadow-sm border border-transparent whitespace-nowrap transition-all day-tab" id="tab-day2">Day 2</button>
                <button onclick="renderDay(3)" class="px-5 py-2.5 bg-white rounded-2xl text-sm font-bold text-[#A69585] shadow-sm border border-transparent whitespace-nowrap transition-all day-tab" id="tab-day3">Day 3</button>
                <button onclick="renderDay(4)" class="px-5 py-2.5 bg-white rounded-2xl text-sm font-bold text-[#A69585] shadow-sm border border-transparent whitespace-nowrap transition-all day-tab" id="tab-day4">Day 4</button>
                <button onclick="renderDay(5)" class="px-5 py-2.5 bg-white rounded-2xl text-sm font-bold text-[#A69585] shadow-sm border border-transparent whitespace-nowrap transition-all day-tab" id="tab-day5">Day 5</button>
            </div>
            <!-- Timeline -->
            <div id="day-content" class="space-y-6 px-1"></div>
        </section>

        <!-- Accounting -->
        <section id="view-accounting" class="hidden fade-in space-y-5">
            <div class="nook-card p-5 bg-white sticky top-0 z-10 shadow-lg border-2 border-[#8DD27E]">
                <div class="grid grid-cols-4 gap-3 mb-3">
                    <select id="acc-cat" class="col-span-1 bg-[#E9F5E6] rounded-xl text-sm font-bold text-[#6BAF5C] text-center outline-none h-12"><option>é£Ÿ</option><option>è¡Œ</option><option>æ¨‚</option><option>è²·</option><option>ä½</option></select>
                    <input type="text" id="acc-item" placeholder="é …ç›®åç¨±" class="col-span-3 bg-[#FAFAFA] border-2 border-[#EEE8D6] rounded-xl px-3 text-sm outline-none font-bold focus:border-[#8DD27E] h-12">
                </div>
                <div class="flex gap-3 mb-4">
                    <input type="number" id="acc-amt" placeholder="0" class="flex-grow bg-[#FAFAFA] border-2 border-[#EEE8D6] rounded-xl px-3 text-lg outline-none font-black focus:border-[#8DD27E] h-12" inputmode="decimal">
                    <select id="acc-curr" class="bg-[#FFF9C4] rounded-xl text-sm px-3 font-bold text-[#E65100] outline-none h-12 border-2 border-[#F9E776]"><option value="JPY">Â¥ JPY</option><option value="TWD">$ TWD</option></select>
                </div>
                <button onclick="addExpense()" class="w-full bg-[#8DD27E] text-white font-black py-3.5 rounded-xl text-lg nook-btn shadow-md active:bg-[#6BAF5C]">ï¼‹ æ–°å¢ç´€éŒ„</button>
            </div>
            <div id="expense-list" class="space-y-3 pb-10"></div>
        </section>

        <!-- Lists -->
        <section id="view-lists" class="hidden fade-in space-y-5">
            <div class="flex gap-3 mb-2 bg-white/50 p-1.5 rounded-2xl">
                <button onclick="listMode='pack'; renderLists()" class="flex-1 py-3 rounded-xl font-bold transition text-sm tracking-wide shadow-sm" id="btn-pack">ğŸ’ å‡ºç™¼å¿…å¸¶</button>
                <button onclick="listMode='shop'; renderLists()" class="flex-1 py-3 rounded-xl font-bold transition text-sm tracking-wide" id="btn-shop">ğŸ›ï¸ è³¼ç‰©é¡˜æœ›</button>
            </div>
            <div class="flex gap-3">
                <input type="text" id="list-input" class="flex-grow p-3 rounded-xl border-2 border-[#EEE8D6] outline-none font-bold focus:border-[#70D3E8]" placeholder="æ–°å¢é …ç›®...">
                <button onclick="addListItem()" class="bg-[#70D3E8] text-white w-12 rounded-xl font-bold text-xl nook-btn shadow-md">+</button>
            </div>
            <div id="list-container" class="space-y-3 pb-10"></div>
        </section>

        <!-- Info -->
        <section id="view-info" class="hidden fade-in space-y-5">
            <div class="nook-card p-5 border-l-[6px] border-[#70D3E8]">
                <h3 class="font-bold text-[#00838F] mb-3 text-lg">ğŸšŒ æ²³å£æ¹–å‘¨éŠå·´å£«</h3>
                <div class="space-y-3">
                    <div class="flex items-start bg-[#E0F7FA] p-3 rounded-xl">
                        <div class="w-4 h-4 rounded-full bg-red-500 mt-1 mr-3 shrink-0 border-2 border-white shadow-sm"></div>
                        <div><div class="font-black text-sm text-[#006064]">ç´…ç·š (Red Line)</div><div class="text-xs text-[#00838F] mt-1">æ¯15åˆ†ä¸€ç­ã€‚å‰å¾€ï¼šå¤©ä¸Šå±±çºœè»Šã€ç¾è¡“é¤¨ã€HOTORIé£¯åº—ã€‚</div></div>
                    </div>
                    <div class="flex items-start bg-[#E8F5E9] p-3 rounded-xl">
                        <div class="w-4 h-4 rounded-full bg-green-500 mt-1 mr-3 shrink-0 border-2 border-white shadow-sm"></div>
                        <div><div class="font-black text-sm text-[#2E7D32]">ç¶ ç·š (Green Line)</div><div class="text-xs text-[#388E3C] mt-1">å‰å¾€ï¼šè¥¿æ¹–ç™‚ç™’ä¹‹é‡Œæ ¹å ´ã€‚</div></div>
                    </div>
                </div>
            </div>
            <div class="nook-card p-5 border-l-[6px] border-[#F9E776]">
                <h3 class="font-bold text-[#796652] mb-3 text-lg">ğŸ¡ ä½å®¿è³‡è¨Š</h3>
                <div class="space-y-4">
                    <div class="relative pl-4 border-l-2 border-[#EEE8D6]">
                        <div class="font-black text-[#6B5643]">ãƒ•ã‚¯ãƒ­ã‚¦ã®å¾¡å®¿ (å‰2æ™š)</div>
                        <div class="text-xs text-[#A69585] mt-1">çŸ³å’Œæº«æ³‰ç«™å—å£ï¼Œæ­è¨ˆç¨‹è»Šç´„10åˆ†é˜ã€‚</div>
                    </div>
                    <div class="relative pl-4 border-l-2 border-[#EEE8D6]">
                        <div class="font-black text-[#6B5643]">HOTORI no HOTEL (å¾Œ2æ™š)</div>
                        <div class="text-xs text-[#A69585] mt-1">ç´…ç·šå·´å£«ã€ŒéŸ³æ¨‚ç›’ä¹‹æ£®ç¾è¡“é¤¨ã€ç«™æ—ã€‚</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Floating Nav Island -->
    <nav class="nav-island absolute bottom-4 left-4 right-4 h-16 flex justify-around items-center z-50">
        <button onclick="switchView('dashboard')" class="nav-item text-[#8DD27E]" id="nav-dashboard"><span class="nav-icon">ğŸ“Š</span>ç¸½è¦½</button>
        <button onclick="switchView('itinerary')" class="nav-item text-[#C0B2A6]" id="nav-itinerary"><span class="nav-icon">ğŸ“…</span>è¡Œç¨‹</button>
        <button onclick="switchView('accounting')" class="nav-item text-[#C0B2A6]" id="nav-accounting"><span class="nav-icon">ğŸ’°</span>è¨˜å¸³</button>
        <button onclick="switchView('lists')" class="nav-item text-[#C0B2A6]" id="nav-lists"><span class="nav-icon">ğŸ“</span>æ¸…å–®</button>
        <button onclick="switchView('info')" class="nav-item text-[#C0B2A6]" id="nav-info"><span class="nav-icon">ğŸ’¡</span>è³‡è¨Š</button>
    </nav>

    <script>
        const FIXED_COST = 36046;
        const RATE = 0.215;
        let db, auth, appId;
        let expenses = [], packList = [], shopList = [], listMode = 'pack';

        const itinerary = {
            1: [{t:"10:35",i:"ğŸ›¬",h:"æŠµé”æˆç”°",d:"IT200 æŠµé”"},{t:"11:44",i:"ğŸš†",h:"N'EX å¾€æ–°å®¿",d:"9/10æœˆå°æ­ä¹˜"},{t:"13:30",i:"ğŸš„",h:"è½‰ä¹˜ Kaiji",d:"æ–°å®¿è½‰ç‰¹æ€¥å¾€çŸ³å’Œæº«æ³‰"},{t:"15:00",i:"ğŸ¡",h:"Check-in",d:"æ­è¨ˆç¨‹è»Šè‡³å¤æ°‘å®¶"}],
            2: [{t:"09:00",i:"ğŸ¯",h:"æƒ æ—å¯º",d:"æ­¦ç”°ä¿¡ç„å¢“æ‰€"},{t:"11:00",i:"ğŸ“",h:"è‰è“åƒåˆ°é£½",d:"Gourmet è‹ºå‰ç”°"},{t:"13:30",i:"ğŸï¸",h:"æ˜‡ä»™å³½",d:"çµ•ç¾æºªè°·å¥è¡Œ"},{t:"18:30",i:"ğŸ·",h:"ç”²åºœæ™šé¤",d:"å¯Œå£«æ«»è±¬ç‚¸è±¬æ’"}],
            3: [{t:"10:08",i:"ğŸšŒ",h:"ç§»å‹•æ—¥(å¿…æ­)",d:"çŸ³å’Œæº«æ³‰ç™¼è»Šå¾€æ²³å£æ¹–"},{t:"12:00",i:"ğŸ˜ï¸",h:"è¥¿æ¹–æ ¹å ´",d:"åˆæŒé€ èšè½"},{t:"15:00",i:"ğŸŒ¸",h:"å¤§çŸ³å…¬åœ’",d:"ç´…ç·šå·´å£«çµ‚é»"},{t:"16:30",i:"ğŸ¨",h:"å…¥ä½ HOTORI",d:"é¢æ¹–æˆ¿å‹"}],
            4: [{t:"09:00",i:"â›©ï¸",h:"å¤©ç©ºé³¥å±…",d:"æ­è¨ˆç¨‹è»Šä¸Šå±±"},{t:"11:30",i:"ğŸœ",h:"Hoto Fudo",d:"é¤ºé£¥éºµåˆé¤"},{t:"14:00",i:"ğŸš ",h:"å¤©ä¸Šå±±çºœè»Š",d:"ä¿¯ç°æ²³å£æ¹–"},{t:"16:00",i:"ğŸ¨",h:"ä¹…ä¿ç”°ä¸€ç«¹",d:"å’Œæœç¾è¡“é¤¨"}],
            5: [{t:"11:00",i:"ğŸ‘‹",h:"é€€æˆ¿",d:"å‰å¾€æ²³å£æ¹–ç«™"},{t:"13:00",i:"ğŸš†",h:"å¯Œå£«å›éŠ",d:"ç›´é”æ–°å®¿"},{t:"17:00",i:"ğŸ›«",h:"å‰å¾€æ©Ÿå ´",d:"N'EX å¾€æˆç”°"},{t:"20:25",i:"âœˆï¸",h:"è¿”å°",d:"IT203"}]
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const urlId = new URLSearchParams(window.location.search).get('id');
            if(urlId) document.getElementById('travel-id-input').value = urlId;
            try { await checkLogin(urlId); } catch(e) { console.error(e); document.getElementById('login-modal').classList.remove('hidden'); }
        });

        async function checkLogin(urlId) {
            const savedId = localStorage.getItem('nook_travel_id');
            const savedConfig = localStorage.getItem('nook_firebase_config');
            const targetId = urlId || savedId;
            
            if (targetId && savedConfig) {
                appId = targetId;
                localStorage.setItem('nook_travel_id', appId);
                document.getElementById('header-id').innerText = `ID: ${appId}`;
                await initFirebase(JSON.parse(savedConfig));
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('main-container').classList.remove('hidden');
                switchView('dashboard');
            } else {
                document.getElementById('login-modal').classList.remove('hidden');
            }
        }

        async function initFirebase(config) {
            if (!firebase.apps.length) firebase.initializeApp(config);
            auth = firebase.auth();
            db = firebase.firestore();
            await auth.signInAnonymously();
            setupListeners();
        }

        function setupListeners() {
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('expenses').orderBy('time', 'desc')
                .onSnapshot(snap => { expenses = snap.docs.map(doc => ({id: doc.id, ...doc.data()})); renderAccounting(); updateDashboard(); });
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('lists').orderBy('time', 'asc')
                .onSnapshot(snap => { const all = snap.docs.map(doc => ({id: doc.id, ...doc.data()})); packList = all.filter(i => i.type === 'pack'); shopList = all.filter(i => i.type === 'shop'); renderLists(); });
        }

        function saveTravelId(btn) {
            const id = document.getElementById('travel-id-input').value.trim();
            if(!localStorage.getItem('nook_firebase_config')) return alert('è«‹å…ˆè¨­å®šé›²ç«¯è³‡æ–™åº«ï¼');
            if(!id) return alert('è«‹è¼¸å…¥ä»£ç¢¼');
            btn.innerText = "ğŸƒ è¼‰å…¥ä¸­...";
            localStorage.setItem('nook_travel_id', id);
            location.href = window.location.pathname;
        }

        function saveConfig(btn) {
            let raw = document.getElementById('config-input').value.trim();
            btn.innerText = "è™•ç†ä¸­...";
            try {
                raw = raw.replace(/\/\/.*$/gm, '').replace(/[\u2018\u2019]/g, "'").replace(/[\u201C\u201D]/g, '"');
                if(raw.includes('=')) raw = raw.substring(raw.indexOf('=') + 1).trim();
                if(raw.endsWith(';')) raw = raw.slice(0, -1).trim();
                let jsonStr = raw.replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:/g, '"$2":').replace(/,(\s*})/g, '$1');
                if(!jsonStr.startsWith('{')) jsonStr = '{' + jsonStr + '}';
                const config = JSON.parse(jsonStr);
                if(!config.apiKey) throw new Error("ç„¡æ•ˆçš„ Config");
                localStorage.setItem('nook_firebase_config', JSON.stringify(config));
                alert('âœ… è¨­å®šå®Œæˆï¼');
                location.reload();
            } catch(e) {
                btn.innerText = "å„²å­˜è¨­å®š";
                alert('æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªè¤‡è£½å…§å®¹ã€‚');
            }
        }

        function resetAll() { if(confirm('ç¢ºå®šé‡ç½® Appï¼Ÿ')) { localStorage.removeItem('nook_travel_id'); localStorage.removeItem('nook_firebase_config'); location.reload(); } }
        function copyShareLink() { const url = window.location.href.split('?')[0] + '?id=' + appId; navigator.clipboard.writeText(url).then(() => alert('ğŸ“‹ ç¶²å€å·²è¤‡è£½ï¼å‚³çµ¦æ—…ä¼´å§ï¼')); }
        function toggleConfigPanel() { document.getElementById('config-panel').classList.toggle('hidden'); }

        function addExpense() {
            const item = document.getElementById('acc-item').value; const amt = document.getElementById('acc-amt').value;
            if(!item || !amt) return;
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('expenses').add({ time: Date.now(), cat: document.getElementById('acc-cat').value, item, amt: parseFloat(amt), curr: document.getElementById('acc-curr').value });
            document.getElementById('acc-item').value = ''; document.getElementById('acc-amt').value = '';
        }
        function delExpense(id) { db.collection('artifacts').doc(appId).collection('public').doc('data').collection('expenses').doc(id).delete(); }
        
        function addListItem() {
            const val = document.getElementById('list-input').value; if(!val) return;
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('lists').add({ time: Date.now(), text: val, type: listMode, checked: false });
            document.getElementById('list-input').value = '';
        }
        function delListItem(id) { db.collection('artifacts').doc(appId).collection('public').doc('data').collection('lists').doc(id).delete(); }

        function renderAccounting() {
            const list = document.getElementById('expense-list'); list.innerHTML = '';
            if(expenses.length === 0) return list.innerHTML = '<div class="text-center text-gray-300 py-10 text-sm font-bold">é‚„æ²’æœ‰è¨˜å¸³å–” ğŸƒ</div>';
            expenses.forEach(ex => {
                const twd = ex.curr === 'JPY' ? Math.round(ex.amt * RATE) : ex.amt;
                list.innerHTML += `<div class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border border-[#EEE8D6] mb-1"><div class="flex items-center"><div class="w-10 h-10 rounded-full bg-[#E9F5E6] flex items-center justify-center mr-3 text-lg">${ex.cat[0]}</div><div><div class="font-bold text-[#6B5643]">${ex.item}</div><div class="text-xs text-[#A69585] font-bold mt-0.5">${ex.amt.toLocaleString()} ${ex.curr}</div></div></div><div class="flex items-center"><span class="font-black text-[#FFB366] mr-4">$${twd.toLocaleString()}</span><button onclick="delExpense('${ex.id}')" class="text-gray-300 hover:text-red-400 text-lg px-2">Ã—</button></div></div>`;
            });
        }

        function renderLists() {
            const list = document.getElementById('list-container'); const data = listMode === 'pack' ? packList : shopList;
            const btnPack = document.getElementById('btn-pack'); const btnShop = document.getElementById('btn-shop');
            
            if(listMode === 'pack') {
                btnPack.className = "flex-1 py-3 rounded-xl font-black transition bg-[#F9E776] text-[#796652] shadow-sm transform scale-105";
                btnShop.className = "flex-1 py-3 rounded-xl font-bold transition text-[#A69585] hover:bg-white/50";
            } else {
                btnShop.className = "flex-1 py-3 rounded-xl font-black transition bg-[#70D3E8] text-white shadow-sm transform scale-105";
                btnPack.className = "flex-1 py-3 rounded-xl font-bold transition text-[#A69585] hover:bg-white/50";
            }

            list.innerHTML = '';
            if(data.length === 0) return list.innerHTML = '<div class="text-center text-gray-300 py-10 text-sm font-bold">æ¸…å–®æ˜¯ç©ºçš„ ğŸƒ</div>';
            data.forEach(item => {
                list.innerHTML += `<div class="flex justify-between items-center bg-white p-4 rounded-2xl border border-[#EEE8D6] mb-1"><span class="font-bold text-[#6B5643] ml-2">${item.text}</span><button onclick="delListItem('${item.id}')" class="text-gray-300 hover:text-red-400 text-lg px-2">Ã—</button></div>`;
            });
        }

        function renderDay(day) {
            document.querySelectorAll('.day-tab').forEach(el => el.className = "px-5 py-2.5 bg-white rounded-2xl text-sm font-bold text-[#A69585] shadow-sm border border-transparent whitespace-nowrap transition-all day-tab");
            document.getElementById(`tab-day${day}`).className = "px-5 py-2.5 bg-[#8DD27E] rounded-2xl text-sm font-bold text-white shadow-md border border-[#8DD27E] whitespace-nowrap transition-all transform scale-105 day-tab";
            
            const container = document.getElementById('day-content'); container.innerHTML = '';
            itinerary[day].forEach(item => {
                container.innerHTML += `<div class="flex relative pl-3 pb-2"><div class="timeline-line"></div><div class="z-10 w-9 h-9 rounded-full bg-[#FFFDF6] border-4 border-[#8DD27E] flex items-center justify-center text-sm mr-4 shrink-0 timeline-dot">${item.i}</div><div class="bg-white p-4 rounded-[1.2rem] border border-[#F0EAE0] flex-grow shadow-sm mb-2"><div class="flex justify-between items-baseline mb-1"><span class="font-black text-[#6B5643] text-lg">${item.h}</span><span class="text-xs font-bold text-[#6BAF5C] bg-[#E9F5E6] px-2 py-1 rounded-lg">${item.t}</span></div><p class="text-xs text-[#A69585] font-bold leading-relaxed">${item.d}</p></div></div>`;
            });
        }

        function updateDashboard() {
            let total = 0; expenses.forEach(e => total += (e.curr === 'JPY' ? Math.round(e.amt * RATE) : e.amt));
            document.getElementById('variable-spent').innerText = total.toLocaleString();
            document.getElementById('total-spent').innerText = (FIXED_COST + total).toLocaleString();
            const p = Math.min((total / (FIXED_COST + total)) * 100, 100);
            document.getElementById('variable-bar').style.width = p + '%';
        }

        function switchView(id) {
            document.querySelectorAll('main > section').forEach(el => { el.classList.add('hidden'); el.classList.remove('fade-in'); });
            const target = document.getElementById(`view-${id}`);
            if(target) { target.classList.remove('hidden'); target.classList.add('fade-in'); }
            
            document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('active'); el.style.color = '#C0B2A6'; });
            const btn = document.getElementById(`nav-${id}`);
            if(btn) { btn.classList.add('active'); btn.style.color = '#8DD27E'; }
            
            if(id === 'itinerary') renderDay(1);
            if(id === 'dashboard') updateDashboard();
        }
    </script>
</body>
</html>
